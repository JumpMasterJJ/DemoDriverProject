<!DOCTYPE html>
<!-- saved from url=(0038)http://bbs.pediy.com/thread-220405.htm -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    
    

    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="XiunoBBS 4.0">
    <meta name="keywords" content="">
    <meta name="description" content="[翻译]多种DLL注入技术原理介绍">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">

    <title>
        [翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛    </title>

    <link rel="shortcut icon" href="http://bbs.pediy.com/view/img/favicon.ico">
    <link rel="icon" sizes="32x32" href="http://bbs.pediy.com/view/img/favicon.ico">
    <link rel="Bookmark" href="http://bbs.pediy.com/view/img/favicon.ico">
        <link rel="stylesheet" href="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bootstrap.min.css">
    
    <link rel="stylesheet" href="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/kanxue.css">

    <style>
/*
box-shadow: 0 0 5px red;
*/
@keyframes xndigest {
	0% { color: red; text-shadow: 0 0 3px #FF8D8D;} 
	20% { color: orange; text-shadow: 0 0 3px #FFE1AD;} 
	40% { color: green; text-shadow: 0 0 3px #B3FFAF;} 
	65% { color: blue; text-shadow: 0 0 3px #AFE4FF;} 
	80% { color: purple; text-shadow: 0 0 3px #FFC9F3;} 
	100% { color: red; text-shadow: 0 0 3px #FF8D8D;} 
}

/*水晶闪烁效果 占内存*/
i.icon-diamond.flash{color: #D53D38;  /*animation: xndigest 5s linear infinite;*/ }

i.icon-digest-1 {  text-shadow: 0 0 3px #AFE4FF; }
i.icon-digest-2 {  text-shadow: 0 0 3px #FFF177; }
i.icon-digest-3 {  text-shadow: 0 0 3px #FF8D8D; }
.icon-digest-1:before { content: "\f219";  color: #5BC0DE;} /* "\f0a5" */
.icon-digest-2:before { content: "\f219";  color: #ECA541;}
.icon-digest-3:before { content: "\f219"; color: #D53D38;}
.icon-digest-3:afteer { content: "精"; color: #D53D38;}
</style><style>
.deleted div.subject > a { text-decoration: line-through; color: grey !important; }
.deleted div.message { text-decoration: line-through; color: grey !important; }
</style><style>
.icon-new { width: 26px; height: 12px; display: inline-block; background: url(view/img/new.gif)}
</style>
<link rel="stylesheet" type="text/css" href="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/syntax.css"><script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/syntax.js"></script><script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/ga.js"></script></head><style type="text/css" id="550889585"></style>

<body>

    

    <!--
<div id="wrapper">
-->

    <!-- 左侧绝对定位？ -->
<div id="mobile_nav">
	<!-- 手机导航 -->
	<table width="100%" class="navbar-nav bg-inverse">
		<tbody><tr>
			<td width="100" height="40">
								<a class="icon-chevron-left xn-back m-l-1" style="max-width: 50%;" href="javascript:history.back();"></a>
							</td>
			<td align="center">
				<div>
										<a class="icon-home xn-back" href="http://bbs.pediy.com/" style="font-size:18px"></a>
									</div>
			</td>
			<td width="100" align="right">
							<a href="http://www.kanxue.com/pm-list-1.htm" class="tel_pm_total_a pm_total_a m-r-1" style="display:inline-block">
					<i class="icon-envelope"></i>
					<span class="tel_pm_total pm_total" style="position: absolute; top: 10px; left: 15px; display: inline-block; padding: 0px 3px; font-size: 12px; font-weight: bold; line-height: 14px; color: white; background-color: rgb(245, 126, 66); border-radius: 9px; text-indent: 0px;"></span> 
				</a>
				<a class="xn-toggle m-r-sm" style="line-height: 40px;" data-target="#nav_top_toggle_user"><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/463708.png" class="avatar-xs"></a>
				<div id="nav_top_toggle_user" style="position: fixed; z-index: 200; right: 0px; top: 42px; opacity: 0.95; min-width: 120px; background:rgba(9,66,110,0.95); display: none;">
				<a style="border-bottom:1px solid #CCCCCC" class="dropdown-item small" href="javascript:void(0);"><b>Hello</b>，MallocFree</a>
				<a class="dropdown-item small" href="http://m.pediy.com/user-463708.htm"><i class="icon-user"></i> <span>我的主页</span></a>
				<a class="dropdown-item small" href="http://passport.kanxue.com/"><i class="icon-cog"></i> <span>设置</span></a>
				<a class="dropdown-item small" href="http://bbs.pediy.com/user-logout.htm"><i class="icon-sign-out"></i> 退出</a>
				</div>
						</td>
		</tr>
	</tbody></table>
</div>

<div id="frame">
	<div id="frame_nav">
		<ul>
			<!--<li>	
				<a href="./"> <span class="logo"></span> <span>首页</span></a>
			</li>-->
			<li data-toggle="tooltip" data-placement="right" data-trigger="hover" data-original-title="" title="">
				<a href="http://www.kanxue.com/" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="首页"><i class="icon-home"></i> <span>首页</span></a>
			</li>
			<li>
				<a href="http://src.kanxue.com/" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="企业 SRC"><i class="icon-cloud"></i> <span>企业 SRC</span></a>
			</li>
			<li>
				<a href="http://ce.kanxue.com/" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="众测"><i class="icon-medkit"></i> <span>众测</span></a>
			</li>
			<!--
			<li>
				<a href="//book.kanxue.com" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="阅读"><i class="icon-book"></i> <span>阅读</span></a>
			</li>
			-->
			<li>
				<a href="http://ctf.pediy.com/" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="CTF"><i class="icon-flag-checkered"></i> <span>CTF</span></a>
			</li>
			<li>
				<a href="http://bbs.pediy.com/" class="active" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="论坛"><i class="icon-comment"></i> <span>论坛</span></a>
			</li>
			<li>
				<a href="http://m.pediy.com/" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="" data-original-title="老论坛"><i class="icon-comment-o"></i> <span>老论坛</span></a>
			</li>
			
			
			
			<li style="position: absolute; bottom: 0;" class="xn-dropdown" data-pos="4">

								<!--<a href="//www.kanxue.com/user.htm" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="我的主页"><i class="icon-user"></i> <span>我的主页</span></a>
				<a href="//passport.kanxue.com/my.htm" data-toggle="tooltip" data-placement="right" data-trigger="hover" title="设置"><i class="icon-cog"></i> <span>设置</span></a>-->
				<!--
					<a href="//passport.kanxue.com/user-logout.htm"  data-toggle="tooltip" data-placement="right" data-trigger="hover" title="退出"><i class="icon-sign-out"></i> <span>退出</span></a>
					-->
				<a href="http://bbs.pediy.com/user-463708.htm">
					<i class="icon-user"></i> <span>我的主页</span>
				</a>
				<a href="http://www.kanxue.com/pm-list-1.htm" class="pm_total_a">
					<i class="icon-envelope"></i>
					<span class="title" data-toggle="modal" data-target="#myModal">短信</span>
					<span class="pm_total" style="display: inline-block; padding: 0px 3px; font-size: 12px; font-weight: bold; line-height: 14px; color: white; background-color: rgb(245, 126, 66); border-radius: 9px; text-indent: 0px;"></span> 
				</a>
				<a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown" data-sign="0"><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/463708.png" class="avatar-xs"> <span>MallocFree</span>
                </a>
                <div class="dropdown-menu" aria-labelledby="nav_user_avatar" style="margin-top: 0px;">
                    <a style="border-bottom:1px solid #CCCCCC" class="dropdown-item small" href="javascript:void(0);"><b>Hello</b>，MallocFree</a>
                    <!-- <a class="dropdown-item small" href="thread-create.htm"><i class="icon-comment"></i> <span>发新帖</span></a> -->
                    <a class="dropdown-item small" href="http://passport.kanxue.com/my.htm"><i class="icon-cog"></i> <span>设置</span></a>
                    <a class="dropdown-item small" href="http://bbs.pediy.com/my-wallet.htm"><i class="icon-credit-card"></i> <span>钱包</span></a>
                    <a class="dropdown-item small" href="http://bbs.pediy.com/user-logout.htm"><i class="icon-sign-out"></i> 退出</a>
                </div>
								
			</li>
			
		</ul>
	</div>
	<div class="frame_left_left_show_button" style="display: block;">
		<a href="javascript:void(0)" title="" style="display: block;"><i class="icon icon-arrow-right"></i></a>
	</div>
	<div id="frame_left" class="frame_left_hide_animation">
		<div class="frame_left_right_hide_button" style="display: block;">
			<a href="javascript:void(0)" title="" style="color:#000;display:block"><i class="icon icon-arrow-left"></i></a>
		</div>
		<div class="" style="width:100%;height:100%;">
			<div style="width:100%;height:100%;">
				
		<style>
span.icon-folder-open {
    color: #2d5475;
}

.catename {
    font-size: 14px;
}

@keyframes play {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.forumlist_logo {
    text-align: center;
    width: 60px;
    height: 60px;
    margin-top: 1rem;
    animation: play 5s linear infinite;
    animation-play-state: paused;
}

.forumlist_logo:hover {
    transform: translate3d(0, 0, 0);
    animation: play 5s linear infinite;
    animation-play-state: forwards;
}

.dropdown-toggle::after {
    margin-left: 0.1rem !important;
}
#search_form { width: 250px; display: block; margin: auto; position: relative; padding: 0px;}
#search_form > input { border-radius: 50px; width: 250px; display: inline-block; text-indent: 32px; background: #B7CEDC; color: #5B8096; border: 1px solid #7194A9; padding: 2px !important; font-size: 12.8px; margin-top: 4px; outline:0;}
#search_form > input:focus { background: #fff; border: 1px solid #7194A9; }
#search_form > span.icon-search { position: absolute; left: 10px; top: 4px;}
::-webkit-input-placeholder { color: #7791A0; }

.forumlist { margin-top: 1rem; }
.forumlist > dl { font-size: 13px; line-height: 2; margin-bottom: 1rem;}
.forumlist > dl > dt {  color:#B7D9EF; font-weight: 800; width: 90px; text-align: right; overflow: hidden;}
.forumlist > dl > dd { color: #fff; }
.forumlist > dl > dd  > a { color: #fff; margin-right: 0.5rem; display: inline-block !important}
.forumlist > dl > dd  > a:hover, .forumlist > dl > dd  > a.active { color: #FFE3AD;}
.forumlist > dl > dd  > a.active { font-weight: 800;}
</style>

<div style="text-align: center; margin-top: 0.5rem">
    <a href="http://bbs.pediy.com/"><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/logo.png" class="forumlist_logo"></a>
</div>
<div style="text-align: center; color: rgba(255,255,255,0.8); margin-top: 0.5rem;">
    看雪论坛
</div>

<form action="http://bbs.pediy.com/search.htm" id="search_form">
    <input type="text" placeholder="关键词 回车搜索" name="keyword">
    <span class="icon-search"></span>
<input type="hidden" name="3xf8gotid0ufnbe9" value="3xf8gotid0ufnbe9"><input type="hidden" name="__anti_xss__" value="1502841785_6bee1b7c8af19356f40b4c94064d1a63"></form>

<div class="forumlist" style="display: none;">
            <dl class="row">
        <dt class="text-nowrap vtop">你问我答 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-20.htm">
                悬赏问答            </a>
                        <a class="" href="http://bbs.pediy.com/forum-117.htm">
                资料导航            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">智能设备 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-128.htm">
                智能设备            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">移动平台 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-161.htm">
                Android安全            </a>
                        <a class="" href="http://bbs.pediy.com/forum-166.htm">
                iOS安全            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">桌面平台 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-4.htm">
                软件逆向            </a>
                        <a class="" href="http://bbs.pediy.com/forum-41.htm">
                编程技术            </a>
                        <a class="" href="http://bbs.pediy.com/forum-88.htm">
                加壳脱壳            </a>
                        <a class="" href="http://bbs.pediy.com/forum-132.htm">
                密码算法            </a>
                        <a class="" href="http://bbs.pediy.com/forum-10.htm">
                资源下载            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">渗透技术 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-151.htm">
                WEB安全            </a>
                        <a class="" href="http://bbs.pediy.com/forum-150.htm">
                二进制漏洞            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">看雪CTF ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-37.htm">
                CrackMe            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">职场风云 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-47.htm">
                招聘专区            </a>
                        <a class="" href="http://bbs.pediy.com/forum-137.htm">
                职业生涯            </a>
                        <a class=" active" href="http://bbs.pediy.com/forum-32.htm">
                外文翻译            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">论坛生活 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-45.htm">
                茶余饭后            </a>
                        <a class="" href="http://bbs.pediy.com/forum-64.htm">
                会员专区            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">看雪产品 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-162.htm">
                企业SRC            </a>
                        <a class="" href="http://bbs.pediy.com/forum-65.htm">
                图书项目            </a>
                    </dd>
    </dl>
        <dl class="row">
        <dt class="text-nowrap vtop">站务管理 ：</dt>
        <dd>
                        <a class="" href="http://bbs.pediy.com/forum-2.htm">
                论坛版务            </a>
                    </dd>
    </dl>
        
         
</div>	
								<!--<div id="frame_left_stats" >
					<span class="hidden-md-down"><span class="text-grey">主题：</span><b>189938</b></span>&nbsp;
					<span class="text-grey">回帖：</span><b>1232203</b>&nbsp;
					<span class="text-grey">会员：</span><b>752913</b>&nbsp;
					<span class="text-grey">在线：</span><b class="text-danger">342</b>
				</div>-->
			</div>
		</div>
	</div>
	<div id="frame_right" tabindex="2">
		<div id="body">
		
						
			
			
		<div style="text-align: right; margin-bottom: -34px; margin-top: 6px;">
			<a href="http://bbs.pediy.com/thread-create-32.htm" role="button" class="btn btn-sm btn-primary m-r-sm m-t-sm">发新帖</a>
		</div>
		
		<ol class="breadcrumb m-b-sm" style="margin-top: 1px;">
			<li class="breadcrumb-item"><a href="http://bbs.pediy.com/" aria-label="首页"><i class="icon-home"></i> 看雪论坛</a></li>
			<li class="breadcrumb-item"><a href="http://bbs.pediy.com/forum-32.htm">『外文翻译』</a></li>
			<!-- <li class="breadcrumb-item active"><a href="thread-220405.htm" title="首页返回主题第一页">[翻译]多种DLL注入技术原理介绍</a></li> -->
			
		</ol>
		
		
		<div class="card card-block">
			<dl class="row">
				<dt class="vtop" style="width: 56px; text-align: center;">
					<div class="avatar_info">
						<a href="http://bbs.pediy.com/user-412913.htm" aria-hidden="true" tabindex="-1">
							<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/412913.png">
						</a>
						<div>
							<span class="group group-105" title="五级"></span>
						</div>
						<div class="text-grey text-tiny" style="text-align: center; margin-top: -6px; ">
														<span class="icon-diamond text-danger" title="精华数"></span><span class="text-bold text-danger"> 4</span>
													</div>
						
					</div>
				</dt>
				<!--
				<dd class="vtop" style="width: 100px;">
					<div class="text-grey" style="font-size: 9px; margin-top: 4px;">
						注册：2011-3 <br>
						帖子：68 <br>
												精华：<span class="text-danger text-bold">4</span> <br>
												<span class="hidden-md-down" title="级别：6 | 在线时长：11天 | 升级还需要：2天"><img src="plugin/kanxue/img/moon.gif" width="13" height="13" style="opacity: 0.65" /><img src="plugin/kanxue/img/star.gif" width="13" height="13" style="opacity: 0.65" /><img src="plugin/kanxue/img/star.gif" width="13" height="13" style="opacity: 0.65" /></span>
					</div>
				</dd>
				-->
				<dd class="vtop">
					
					<h3 class="break-all subject">
												
																								[翻译]多种DLL注入技术原理介绍																		
												
			<i class="icon-digest-3" aria-hidden="true" title="精华"></i>
							
					</h3>
					
					<dl class="row small">
						<dt style="padding: 0px;">
							
							<span class="username text-bold">
								<a href="http://bbs.pediy.com/user-412913.htm">木无聊偶</a>
							</span>
							
							
							<span class="date text-grey m-l-1">2天前</span>
							<span class="text-grey m-l-1 hidden-md-down"><i class="icon-eye" aria-hidden="true"></i> 923</span>
							
						</dt>
						<dd class="text-right">
							
							<a href="javascript:void(0);" class="text-grey m-r-1 modal-title" id="exampleModalLabel" data-toggle="modal" data-target=".report" data-tid="220405" data-pid="1491088"><i class="icon-warning" aria-hidden="true"></i> 举报</a>
														
														
						</dd>
					</dl>
														</dd>
			</dl>
			<hr aria-hidden="true">
			<div class="message break-all" isfirst="1">
						
				
				<p>											</p><p>											</p><p style="text-indent:28px;"><span style="font-family:宋体;">现在是</span><span>2017</span><span style="font-family:宋体;">年，本文中我将介绍</span><span>DLL</span><span style="font-family:宋体;">注入的相关知识。不算太糟的是，</span><span>DLL</span><span style="font-family:宋体;">注入技术可以被正常软件用来添加</span><span>/</span><span style="font-family:宋体;">扩展其他程序，调试或逆向工程的功能性；该技术也常被恶意软件以多种方式利用。这意味着从安全角度来说，了解</span><span>DLL</span><span style="font-family:宋体;">注入的工作原理是十分必要的。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">不久前在为攻击方测试（目的是为了模拟不同类型的攻击行为）开发定制工具的时候，我编写了这个名为“</span><span>injectAllTheThings</span><span style="font-family:宋体;">”的小工程的大部分代码。如果你想看一下利用</span><span>DLL</span><span style="font-family:宋体;">注入实施的攻击行为的若干示例，请参阅网址：</span><span><a href="https://attack.mitre.org/wiki/Technique/T1055">https://attack.mitre.org/wiki/Technique/T1055</a></span><span style="font-family:宋体;">。如果你想学习</span><span>DLL</span><span style="font-family:宋体;">注入的相关知识，你会发现该工程也是有用的。当你想要查询这类信息</span><span>/</span><span style="font-family:宋体;">代码时，你会发现网上充斥着垃圾；我的代码可能也属于垃圾。我并不是程序员，我只是在需要时对代码进行修改。无论如何，我以一种便于阅读和理解的方式，将多种能在</span><span>32</span><span style="font-family:宋体;">位和</span><span>64</span><span style="font-family:宋体;">位环境下生效的</span><span>DLL</span><span style="font-family:宋体;">注入技术（事实上一共</span><span>7</span><span style="font-family:宋体;">种不同的技术），整合到了一个单独的</span><span>Visual Studio</span><span style="font-family:宋体;">工程之中。有些朋友对这些代码感兴趣，所以它也可能会吸引你。为了区分，每种技术有其独有的源文件。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">下图为工具的输出信息，其中显示了所有的选项和实现的技术。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/screen.png" style="width: 909.203px; height: auto;"></p><p style="text-indent:28px;"><span style="font-family:宋体;">网友</span><span>@SubTee</span><span style="font-family:宋体;">认为，</span><span>DLL</span><span style="font-family:宋体;">注入是多余的（如下图所示）；我倾向于同意</span><span>TA</span><span style="font-family:宋体;">的观点，然而</span><span>DLL</span><span style="font-family:宋体;">注入并不仅仅是加载</span><span>DLL</span><span style="font-family:宋体;">那么简单。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/lame.png"></p><p>&nbsp; &nbsp; 你确实可以利用签名认证的微软二进制文件来加载DLL，但你无法附加到一个特定的进程来干预其内存内容。为什么大部分渗透测试师实际上不知道DLL注入是什么，或者它是如何工作的？因为Metasploit平台替他们包办的太多了；他们一直盲目地使用它。我认为，学习这种“奇特的”内存操作技术的最好地点，实际上是游戏黑客论坛。如果你正在进行攻击方测试，那么你就必须干这些“脏”活儿，同时研究这些技术；除非你乐意仅仅使用别人随意编写的工具。</p><p>大部分时间，我们使用很复杂的技术开始一次攻击方测试；如果我们未被发现，则开始降低复杂度。基本上这就是我们开始向磁盘投放二进制文件和应用DLL注入技术的时间点。</p><p>&nbsp; &nbsp; 本文试图以一种简单而高阶的方式纵览DLL注入技术，同时为GitHub中的项目（网址为：https://github.com/fdiskyou/injectAllTheThings）提供“文档”支持。</p><p><br></p><p><strong>&nbsp; &nbsp; 简介</strong></p><p>&nbsp; &nbsp; DLL注入技术，一般来讲是向一个正在运行的进程插入/注入代码的过程。我们注入的代码以动态链接库（DLL）的形式存在。DLL文件在运行时将按需加载（类似于UNIX系统中的共享库）。本工程中，我将仅使用DLL文件，然而实际上，我们可以以其他的多种形式“注入“代码（正如恶意软件中所常见的，任意PE文件，shellcode代码/程序集等）。</p><p>&nbsp; &nbsp; 同时要记住，你需要合适的权限级别来操控其他进程的内存空间。但我不会在此讨论保护进程（相关网址：https://www.microsoftpressstore.com/articles/article.aspx?p=2233328&amp;seqNum=2）和权限级别（通过Vista系统介绍，相关网址：https://msdn.microsoft.com/en-gb/library/windows/desktop/bb648648(v=vs.85).aspx）；这属于完全不同的另一个主题。</p><p>&nbsp; &nbsp; 再次强调一下，正如我之前所说，DLL注入技术可以被用于合法正当的用途。比如，反病毒软件和端点安全解决方案使用这些技术来将其软件的代码嵌入/拦截系统中“所有”正在运行的进程，这使得它们可以在其运行过程中监控每一个进程，从而更好地保护我们。同样存在恶意的用途。一种经常被用到的通用技术是注入“lsass”进程来获取口令哈希值。我们之前都这么干过。很明显，恶意代码同样广泛应用了代码注入技术：不管是运行shellcode代码，运行PE文件，还是在另一个进程的内存空间中加载DLL文件以隐藏自身，等等。</p><p><br></p><p><strong>&nbsp; &nbsp; 基础知识</strong></p><p>&nbsp; &nbsp; 对于每一种技术，我们都将用到微软Windows API，因为它为我们提供了大量的函数来附加和操纵其他进程。从微软Windows操作系统的第一个版本开始，DLL文件就是其基石。事实上，微软Windows API中的所有函数都包含于DLL文件之中。其中，最重要的是“Kernel32.dll”（包含管理内存，进程和线程相关的函数），“User32.dll”（大部分是用户接口函数），和“GDI32.dll”（绘制图形和显示文本相关的函数）。</p><p>&nbsp; &nbsp; 你可能会有疑问，为什么会有这些API接口，为什么微软为我们提供如此丰富的函数集来操纵和修改其他进程的内存空间？主要原因是为了扩展应用程序的功能。比如，一个公司创建了一款应用程序，并且允许其他公司来扩展或增强这个应用程序；如此，这就有了一个合法正当的用途。除此之外，DLL文件还用于项目管理，内存保护，资源共享，等等。</p><p>&nbsp; &nbsp; 下图尝试说明了几乎每一种DLL注入技术的流程。</p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/diagram.png"></p><p>&nbsp; &nbsp; 如上所见，我认为DLL注入共四个步骤：</p><p>&nbsp; &nbsp; 1.附加到目标/远程进程</p><p>&nbsp; &nbsp; 2.在目标/远程进程内分配内存</p><p>&nbsp; &nbsp; 3.将DLL文件路径，或者DLL文件，复制到目标/远程进程的内存空间</p><p>&nbsp; &nbsp; 4.控制进程运行DLL文件</p><p>&nbsp; &nbsp; 所有这些步骤是通过调用一系列指定的API函数来完成的。每种技术需要进行特定的设置和选项配置。我认为，每种技术都有其优点和缺点</p><p>&nbsp; &nbsp; （1）技术介绍</p><p>&nbsp; &nbsp; &nbsp;我们有多种方式可以控制进程运行我们的DLL文件。最普通的应该是“CreateRemoteThread()”和“NtCreateThreadEx()”函数；然而，不可能仅仅向这些函数传递一个DLL文件作为参数，我们必须提供一个包含执行起点的内存地址。为此，我们需要分配内存，使用“LoadLibrary()”加载我们的DLL文件，复制内存，等等。</p><p>&nbsp; &nbsp; 我称之为“injectAllTheThings”的工程（因为我只是单纯讨厌“注入器”这个名字，加上GitHub上已经有太多的垃圾“注入器”，而我不想再多一个了）包含7种不同的技术；我并不是其中任何一种技术的原创作者，而是提炼总结了这七种技术（是的，还有更多）。其中某些已经有很多文档资料描述（像“CreateRemoteThread()”），而另一些则属于未公开API函数（像“NtCreateThreadEx()”）。以下是所实现的技术的完整列表，其中每种都可以在32位和64位环境下生效。</p><p>&nbsp; &nbsp; •CreateRemoteThread()</p><p>&nbsp; &nbsp; •NtCreateThreadEx()</p><p>&nbsp; &nbsp; •QueueUserAPC</p><p>&nbsp; &nbsp; •SetWindowsHookEx()</p><p>&nbsp; &nbsp; •RtlCreateUserThread()</p><p>&nbsp; &nbsp; •利用SetThreadContext()找到的代码区域</p><p>&nbsp; &nbsp; •反射DLL</p><p>&nbsp; &nbsp; 你可能通过其他的名字了解其中某些技术。以上并不是包含每一种DLL注入技术的完整列表；正如我所说的，还有更多技术，如果之后我在某个工程中需要对其接触学习的话我会将它们添加进来。到目前为止，这就是我在某些工程中所用到的技术列表；其中某些可以稳定利用，某些不可以。需要注意的是，不能够稳定利用的那些技术可能是由于我所编写代码的自身问题。</p><p>&nbsp; &nbsp; （2）LoadLibrary()</p><p>&nbsp; &nbsp; 正如MSDN中所述，“LoadLibrary()”函数“被用于向调用进程的地址空间加载指定模块，而该指定模块可能导致其他模块被加载”。函数原型与参数说明如下所示：</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HMODULE</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;LoadLibrary(</code></div><div class="line number2 index1 alt1"><code class="cpp plain">_IN_&nbsp;LPCRSTR&nbsp;lpFileName</code></div><div class="line number3 index2 alt2"><code class="cpp plain">);</code></div><div class="line number4 index3 alt1"><code class="cpp plain">lpFileName&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number5 index4 alt2"><code class="cpp plain">模块名称。该模块可能是一个库模块（.dll文件），或者一个可执行模块（.exe文件）</code></div><div class="line number6 index5 alt1"><code class="cpp plain">（…）</code></div><div class="line number7 index6 alt2"><code class="cpp plain">若字符串指定了一个完全路径，则函数只在该路径下搜索模块；</code></div><div class="line number8 index7 alt1"><code class="cpp plain">若字符串指定了一个相对路径或者无路径的模块名称，则函数使用标准搜索策略来查找模块。</code></div><div class="line number9 index8 alt2"><code class="cpp plain">（…）</code></div><div class="line number10 index9 alt1"><code class="cpp plain">若函数无法找到模块，则函数执行失败。当指定路径时，必须使用反斜线（\）而不是斜线（/）。</code></div><div class="line number11 index10 alt2"><code class="cpp plain">（…）</code></div><div class="line number12 index11 alt1"><code class="cpp plain">如果字符串指定了一个无路径的模块名称并且无文件名后缀，则函数默认在模块名称后面添加库文件后缀.dll。</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">换言之，该函数只需要一个文件名作为其唯一的参数。即，我们只需要为我们的</span><span>DLL</span><span style="font-family:宋体;">文件路径分配内存，将执行起点设置为“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”函数的地址，之后将路径的内存地址传递给函数作为参数。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">正如你所知道（或不知道）的，最大的问题是“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”会向程序注册已加载的</span><span>DLL</span><span style="font-family:宋体;">模块；这意味着这种方法很容易被检测到，但令人惊奇的是很多端点安全解决方案仍检测不出。不管怎样，正如我之前所说，</span><span>DLL</span><span style="font-family:宋体;">注入也有一些合法正当的用途，因此我们还要注意的是，如果一个</span><span>DLL</span><span style="font-family:宋体;">文件已经用“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”加载过了，则它不会再次执行。你可以试验一下，但我没有对任何一种技术试过。当然，使用反射</span><span>DLL</span><span style="font-family:宋体;">注入技术不会有这方面的问题，因为</span><span>DLL</span><span style="font-family:宋体;">模块并未被注册。不同于使用“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”，反射</span><span>DLL</span><span style="font-family:宋体;">注入技术将整个</span><span>DLL</span><span style="font-family:宋体;">文件载入内存，然后通过确定</span><span>DLL</span><span style="font-family:宋体;">模块的入口点偏移来将其加载；这样可以按照需求更隐蔽的对其进行调用。取证人员仍然能够在内存中找到你的</span><span>DLL</span><span style="font-family:宋体;">，但会很艰难。</span><span>Metasploit</span><span style="font-family:宋体;">平台大量使用了这项技术，而且大部分端点解决方案也还乐意始终使用它。如果你想查找这方面的技术资料，或者你在攻防游戏中处于防守方，可以参阅以下网址：</span></p><p style="text-indent:28px;"><span><a href="https://www.defcon.org/html/defcon-20/dc-20-speakers.html#King">https://www.defcon.org/html/defcon-20/dc-20-speakers.html#King</a></span></p><p style="text-indent:28px;"><span><a href="https://github.com/aking1012/dc20">https://github.com/aking1012/dc20</a></span></p><p style="text-indent:28px;"><span style="font-family:宋体;">附注一下，如果你正在折腾你的端点安全软件，而它很好地利用了以上所有这些技术，你可能需要使用以下攻防反欺骗引擎来试试（注意，我只是尝试轻松的说法，以便你能理解）。某些反欺骗工具的反</span><span>Rookit</span><span style="font-family:宋体;">性能要比某些反病毒软件要先进得多。</span><span><a href="https://www.reddit.com/r/netsec/comments/4yqjis/i_am_nick_cano_author_of_game_hacking_developing/">reddit</a></span><span style="font-family:宋体;">网站上有一本书你肯定读过，叫“</span><span><a href="https://www.nostarch.com/gamehacking"><span style="font-family:宋体;">黑客游戏</span></a></span><span style="font-family:宋体;">”，它的作者</span><span><a href="https://twitter.com/nickcano93">Nick Cano</a></span><span style="font-family:宋体;">对其有非常深入的研究；只需了解一下他的工作，你就会理解我所谈论的内容。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;"><br></span></p><p style="text-indent:28px;"><strong style="line-height:1.7;"><span style="font-family:宋体;">附加到目标</span>/</strong><strong style="line-height:1.7;"><span style="font-family:宋体;">远程进程</span></strong></p><p style="text-indent:28px;"><span style="font-family:宋体;">首先，我们需要获取我们想要交互的进程句柄；为此我们调用“</span><span>OpenProcess()</span><span style="font-family:宋体;">”</span><span>API</span><span style="font-family:宋体;">函数。函数原型如下：</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;OpenProcess(</code></div><div class="line number2 index1 alt1"><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">dwDesiredAccess,&nbsp;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">BOOL</code>&nbsp;&nbsp;&nbsp;<code class="cpp plain">bInheritHandle,&nbsp;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">dwProcessId</code></div><div class="line number5 index4 alt2"><code class="cpp plain">);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">如果你读过</span><span>MSDN</span><span style="font-family:宋体;">中相关的文档，那么你应该知道我们需要请求获取一系列特定的访问权限；访问权限的完整列表参阅网址：</span><span><a href="https://msdn.microsoft.com/en-gb/library/windows/desktop/ms684880(v=vs.85).aspx">https://msdn.microsoft.com/en-gb/library/windows/desktop/ms684880(v=vs.85).aspx</a></span><span style="font-family:宋体;">。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">这些权限随微软</span><span>Windows</span><span style="font-family:宋体;">操作系统版本不同而不同；以下调用代码可用于几乎每一种技术之中：</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">hProcess&nbsp;=&nbsp;OpenProcess(</code></div><div class="line number2 index1 alt1"><code class="cpp plain">PROCESS_QUERY_INFORMATION&nbsp;|&nbsp;</code></div><div class="line number3 index2 alt2"><code class="cpp plain">PROCESS_CREATE_THREAD&nbsp;|&nbsp;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">PROCESS_VM_OPERATION&nbsp;|&nbsp;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">PROCESS_VM_WRITE,&nbsp;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">FALSE,&nbsp;dwProcessId&nbsp;);</code></div></div></td></tr></tbody></table><p>&nbsp; &nbsp; <strong>在目标/远程进程空间分配内存</strong></p><p>&nbsp; &nbsp; 我们调用“VirtualAllocEx()”函数为DLL路径分配内存。正如MSDN中所述，“VirtualAllocEx()”函数“保留，提交或改变指定进程虚拟地址空间中的一块内存区域的状态；函数通过置零来初始化内存。”函数原型如下：</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">LPVOID</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;VirtualAllocEx(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">hProcess,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_opt_&nbsp;</code><code class="cpp color1 bold">LPVOID</code>&nbsp;<code class="cpp plain">lpAddress,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">SIZE_T</code>&nbsp;<code class="cpp plain">dwSize,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;&nbsp;<code class="cpp plain">flAllocationType,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;&nbsp;<code class="cpp plain">flProtect</code></div><div class="line number7 index6 alt2"><code class="cpp plain">);</code></div></div></td></tr></tbody></table><p><span style="font-size:14px; font-family:宋体;">&nbsp; &nbsp; 基本上，我们进行如下的调用操作：</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp comments">//&nbsp;计算DLL文件路径名称所需的字节数</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">dwSize&nbsp;=&nbsp;(lstrlenW(pszLibFile)&nbsp;+&nbsp;1)&nbsp;*&nbsp;</code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">(</code><code class="cpp color1 bold">wchar_t</code><code class="cpp plain">);</code></div><div class="line number3 index2 alt2"><code class="cpp comments">//&nbsp;在目标/远程进程中为路径名称分配空间</code></div><div class="line number4 index3 alt1"><code class="cpp color1 bold">LPVOID</code>&nbsp;<code class="cpp plain">pszLibFileRemote&nbsp;=&nbsp;(</code><code class="cpp color1 bold">PWSTR</code><code class="cpp plain">)VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;dwSize,&nbsp;MEM_COMMIT,&nbsp;PAGE_READWRITE);</code></div></div></td></tr></tbody></table><p><span style="font-size:14px; font-family:宋体;"></span></p><p style="text-indent:28px;"><span style="font-family:宋体;">或者你可以更聪明一点地调用“</span><span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364963%28v=vs.85%29.aspx">GetFullPathName()</a></span><span style="font-family:宋体;">”</span><span>API</span><span style="font-family:宋体;">函数；然后，我在整个工程中都没有调用这个</span><span>API</span><span style="font-family:宋体;">函数，仅仅是出于个人偏好或者是不够聪明。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">如果你想要为整个</span><span>DLL</span><span style="font-family:宋体;">文件分配空间，就必须进行如下操作：</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">hFile&nbsp;=&nbsp;CreateFileW(pszLibFile,&nbsp;GENERIC_READ,&nbsp;0,&nbsp;NULL,&nbsp;OPEN_EXISTING,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL);</code></div><div class="line number2 index1 alt1"><code class="cpp plain">dwSize,&nbsp;=&nbsp;GetFileSize(hFile,&nbsp;NULL);</code></div><div class="line number3 index2 alt2"><code class="cpp color1 bold">PVOID</code>&nbsp;<code class="cpp plain">pszLibFileRemote&nbsp;=&nbsp;(</code><code class="cpp color1 bold">PWSTR</code><code class="cpp plain">)VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;dwSize,&nbsp;MEM_COMMIT,&nbsp;PAGE_READWRITE);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span>&nbsp;</span></p><p style="text-indent:28px;"><strong><span style="font-family:宋体;">复制</span><span>DLL</span></strong><strong><span style="font-family:宋体;">文件路径（或者</span><span>DLL</span></strong><strong><span style="font-family:宋体;">文件）到目标</span><span>/</span></strong><strong><span style="font-family:宋体;">远程进程的内存空间中</span></strong></p><p style="text-indent:28px;"><span style="font-family:宋体;">现在，我们需要调用“</span><span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674%28v=vs.85%29.aspx">WriteProcessMemory()</a></span><span style="font-family:宋体;">”</span><span>API</span><span style="font-family:宋体;">函数，来将我们的</span><span>DLL</span><span style="font-family:宋体;">文件路径，或者整个</span><span>DLL</span><span style="font-family:宋体;">文件，复制到目标</span><span>/</span><span style="font-family:宋体;">远程进程中。函数原型如下所示：</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">BOOL</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;WriteProcessMemory(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code>&nbsp;&nbsp;<code class="cpp plain">hProcess,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;</code><code class="cpp color1 bold">LPVOID</code>&nbsp;&nbsp;<code class="cpp plain">lpBaseAddress,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;</code><code class="cpp color1 bold">LPCVOID</code>&nbsp;<code class="cpp plain">lpBuffer,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;&nbsp;</code><code class="cpp color1 bold">SIZE_T</code>&nbsp;&nbsp;<code class="cpp plain">nSize,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_Out_&nbsp;</code><code class="cpp color1 bold">SIZE_T</code>&nbsp;&nbsp;<code class="cpp plain">*lpNumberOfBytesWritten</code></div><div class="line number7 index6 alt2"><code class="cpp plain">);</code></div></div></td></tr></tbody></table><p>&nbsp; &nbsp; 一般的调用代码如下所示：</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">n&nbsp;=&nbsp;WriteProcessMemory(hProcess,&nbsp;pszLibFileRemote,&nbsp;(</code><code class="cpp color1 bold">PVOID</code><code class="cpp plain">)pszLibFile,&nbsp;dwSize,&nbsp;NULL);</code></div></div></td></tr></tbody></table><p>&nbsp; &nbsp; 如果我们想要像反射DLL注入技术所做的那样复制整个DLL文件，就需要更多的代码，因为在将其复制到目标/远程进程之前我们需要将其读入内存。具体代码如下所示：</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">lpBuffer&nbsp;=&nbsp;HeapAlloc(GetProcessHeap(),&nbsp;0,&nbsp;dwLength)</code></div><div class="line number2 index1 alt1"><code class="cpp plain">ReadFile(hFile,&nbsp;lpBuffer,&nbsp;dwLength,&nbsp;&amp;dwBytesRead,&nbsp;NULL)</code></div><div class="line number3 index2 alt2"><code class="cpp plain">WriteProcessMemory(hProcess,&nbsp;pszLibFileRemote,&nbsp;(</code><code class="cpp color1 bold">PVOID</code><code class="cpp plain">)pszLibFile,&nbsp;dwSize,&nbsp;NULL);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">正如之前所述，通过使用反射</span><span>DLL</span><span style="font-family:宋体;">注入技术，以及将</span><span>DLL</span><span style="font-family:宋体;">文件复制到内存中，进程不会记录该</span><span>DLL</span><span style="font-family:宋体;">模块。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">但这样会有一点复杂，因为当</span><span>DLL</span><span style="font-family:宋体;">模块加载到内存中时我们需要获取其入口点；反射</span><span>DLL</span><span style="font-family:宋体;">工程的“</span><span>LoadRemoteLibraryR()</span><span style="font-family:宋体;">”函数部分为我们完成了这项工作。如有需要请参阅源码。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">需要注意的是，我们将注入的</span><span>DLL</span><span style="font-family:宋体;">文件需要使用适当的包含与选项来进行编译，这样它才能与</span><span>ReflectiveDLLInjection</span><span style="font-family:宋体;">方法相匹配。“</span><span>InjectAllThings</span><span style="font-family:宋体;">”工程中包含了一个名为“</span><span>rdll_32.dll/rdll_64.dll</span><span style="font-family:宋体;">”的</span><span>DLL</span><span style="font-family:宋体;">文件，可用于练习。</span></p><p style="text-indent:28px;"><span>&nbsp;</span></p><p style="text-indent:28px;"><strong><span style="font-family:宋体;">控制进程来运行</span><span>DLL</span></strong><strong><span style="font-family:宋体;">文件</span></strong></p><p style="text-indent:28px;"><span style="font-family:宋体;">（</span><span>1</span><span style="font-family:宋体;">）</span><span>CreateRemoteThread()</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">可以说，“</span><span>CreateRemoteThread()</span><span style="font-family:宋体;">”是最传统和最流行，以及最多文档资料介绍的</span><span>DLL</span><span style="font-family:宋体;">注入技术。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">它包括以下几个步骤：</span></p><p style="text-indent:28px;"><span>1.</span><span style="font-family:宋体;">使用</span><span>OpenProcess()</span><span style="font-family:宋体;">函数打开目标进程</span></p><p style="text-indent:28px;"><span>2.</span><span style="font-family:宋体;">通过调用</span><span>GetProAddress()</span><span style="font-family:宋体;">函数找到</span><span>LoadLibrary()</span><span style="font-family:宋体;">函数的地址</span></p><p style="text-indent:28px;"><span>3.</span><span style="font-family:宋体;">通过调用</span><span>VirtualAllocEx()</span><span style="font-family:宋体;">函数在目标</span><span>/</span><span style="font-family:宋体;">远程进程地址空间中为</span><span>DLL</span><span style="font-family:宋体;">文件路径开辟内存空间</span></p><p style="text-indent:28px;"><span>4.</span><span style="font-family:宋体;">调用</span><span>WriteProcessMemory()</span><span style="font-family:宋体;">函数在之前所分配的内存空间中写入</span><span>DLL</span><span style="font-family:宋体;">文件路径</span></p><p style="text-indent:28px;"><span>5.</span><span style="font-family:宋体;">调用</span><span>CreateRemoteThread()</span><span style="font-family:宋体;">函数创建一个新的线程，新线程以</span><span>DLL</span><span style="font-family:宋体;">文件路径名称作为参数来调用</span><span>LoadLibrary()</span><span style="font-family:宋体;">函数</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">如果你看过</span><span>MSDN</span><span style="font-family:宋体;">中关于“</span><span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682437%28v=vs.85%29.aspx">CreateRemoteThread()</a></span><span style="font-family:宋体;">”函数的文档，那么你应该知道，我们需要一个指针，“指向将由线程执行的，类型为‘</span><span>LPTHREAD_START_ROUTINE</span><span style="font-family:宋体;">’的应用程序定义函数，并且该指针代表远程进程中线程的起始地址”。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">这意味着要运行我们的</span><span>DLL</span><span style="font-family:宋体;">文件，我们只需要控制进程来做就好（译者注：由下文可知，应该是将“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”函数作为线程的启动函数，来加载待注入的</span><span>DLL</span><span style="font-family:宋体;">文件）。很简单。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">以下代码即之前所列的全部基本步骤。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">hProcess&nbsp;=&nbsp;OpenProcess(PROCESS_QUERY_INFORMATION&nbsp;|&nbsp;PROCESS_CREATE_THREAD&nbsp;|&nbsp;PROCESS_VM_OPERATION&nbsp;|&nbsp;PROCESS_VM_WRITE,&nbsp;FALSE,&nbsp;dwProcessId);</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp comments">//&nbsp;在远程进程中为路径名称分配空间</code></div><div class="line number4 index3 alt1"><code class="cpp color1 bold">LPVOID</code>&nbsp;<code class="cpp plain">pszLibFileRemote&nbsp;=&nbsp;(</code><code class="cpp color1 bold">PWSTR</code><code class="cpp plain">)VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;dwSize,&nbsp;MEM_COMMIT,&nbsp;PAGE_READWRITE);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp comments">//&nbsp;将DLL路径名称复制到远程进程地址空间</code></div><div class="line number7 index6 alt2"><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">n&nbsp;=&nbsp;WriteProcessMemory(hProcess,&nbsp;pszLibFileRemote,&nbsp;(</code><code class="cpp color1 bold">PVOID</code><code class="cpp plain">)pszLibFile,&nbsp;dwSize,&nbsp;NULL);</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number9 index8 alt2"><code class="cpp comments">//&nbsp;获取Kernel32.dll中的LoadLibraryW函数的真正地址</code></div><div class="line number10 index9 alt1"><code class="cpp plain">PTHREAD_START_ROUTINE&nbsp;pfnThreadRtn&nbsp;=&nbsp;(PTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandle(TEXT(</code><code class="cpp string">"Kernel32"</code><code class="cpp plain">)),&nbsp;</code><code class="cpp string">"LoadLibraryW"</code><code class="cpp plain">);</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number12 index11 alt1"><code class="cpp comments">//&nbsp;创建远程线程调用LoadLibraryW(DLLPathname)</code></div><div class="line number13 index12 alt2"><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">hThread&nbsp;=&nbsp;CreateRemoteThread(hProcess,&nbsp;NULL,&nbsp;0,&nbsp;pfnThreadRtn,&nbsp;pszLibFileRemote,&nbsp;0,&nbsp;NULL);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">完整代码请参阅源文件“</span><span>t_CreateRemoteThread.cpp</span><span style="font-family:宋体;">”。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">（</span><span>2</span><span style="font-family:宋体;">）</span><span>NtCreateThreadEx()</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">另一个选择是使用“</span><span><a href="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FNtCreateThread.html">NtCreateThreadEx()</a></span><span style="font-family:宋体;">”函数；这是一个未公开的“</span><span>ntdll.dll</span><span style="font-family:宋体;">”中的函数，未来可能会消失或改变。这种技术相比而言实现更加复杂，因为我们需要一个结构体（具体如下所示）来向函数传递参数，以及另一个结构体用于从函数接收数据。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code>&nbsp;<code class="cpp plain">NtCreateThreadExBuffer&nbsp;{</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Size;</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown1;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown2;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">PULONG</code>&nbsp;<code class="cpp plain">Unknown3;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown4;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown5;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown6;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">PULONG</code>&nbsp;<code class="cpp plain">Unknown7;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">ULONG</code>&nbsp;<code class="cpp plain">Unknown8;</code></div><div class="line number11 index10 alt2"><code class="cpp plain">};</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">网址：</span><span><a href="http://securityxploded.com/ntcreatethreadex.php">http://securityxploded.com/ntcreatethreadex.php</a></span><span style="font-family:宋体;">处的文章详细介绍了该函数调用。设置部分与“</span><span>CreateRemoteThread()</span><span style="font-family:宋体;">”非常类似；然而，相较于直接调用“</span><span>CreateRemoteThread()</span><span style="font-family:宋体;">”函数，我们使用如下代码来调用“</span><span>NtCreateThreadEx()</span><span style="font-family:宋体;">”。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">PTHREAD_START_ROUTINE&nbsp;ntCreateThreadExAddr&nbsp;=&nbsp;(PTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandle(TEXT(</code><code class="cpp string">"ntdll.dll"</code><code class="cpp plain">)),&nbsp;</code><code class="cpp string">"NtCreateThreadEx"</code><code class="cpp plain">);</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp plain">LPFUN_NtCreateThreadEx&nbsp;funNtCreateThreadEx&nbsp;=&nbsp;(LPFUN_NtCreateThreadEx)ntCreateThreadExAddr;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp plain">NTSTATUS&nbsp;status&nbsp;=&nbsp;funNtCreateThreadEx(</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">&amp;hRemoteThread,</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">0x1FFFFF,</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NULL,</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">hProcess,</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">pfnThreadRtn,</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">(</code><code class="cpp color1 bold">LPVOID</code><code class="cpp plain">)pszLibFileRemote,</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">FALSE,</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NULL,</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NULL,</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NULL,</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NULL</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">);</code></div></div></td></tr></tbody></table><p>&nbsp; &nbsp; 完整代码请参阅源文件“t_NtCreateThreadEx.cpp”。</p><p>&nbsp; &nbsp; （3）QueueUserAPC()</p><p>&nbsp; &nbsp; 除了之前介绍的方法还有一种选择，不用在目标/远程进程中创建一个新的线程，那就是“QueueUserAPC()”函数。</p><p>&nbsp; &nbsp; 根据MSDN中的文档介绍，该函数“向指定线程的APC队列中添加一个用户态的异步过程调用（APC）对象”。</p><p>&nbsp; &nbsp; 函数原型与参数说明如下所示。</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;QueueUserAPC(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;PAPCFUNC&nbsp;&nbsp;pfnAPC,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">HANDLE</code>&nbsp;&nbsp;&nbsp;&nbsp;<code class="cpp plain">hThread,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">ULONG_PTR</code>&nbsp;<code class="cpp plain">dwData</code></div><div class="line number5 index4 alt2"><code class="cpp plain">);</code></div><div class="line number6 index5 alt1"><code class="cpp plain">pfnAPC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number7 index6 alt2"><code class="cpp plain">指向应用程序提供的APC函数的指针，该函数在指定线程执行一个可唤醒等待操作的时候被调用。（…）</code></div><div class="line number8 index7 alt1"><code class="cpp plain">HThread&nbsp;&nbsp;[输入参数]</code></div><div class="line number9 index8 alt2"><code class="cpp plain">线程句柄。该句柄必须具备THREAD_SET_CONTEXT访问权限。（…）</code></div><div class="line number10 index9 alt1"><code class="cpp plain">dwData&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number11 index10 alt2"><code class="cpp plain">传递给pfnAPC参数所指向的APC函数的一个值</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">因此，如果不想创建我们自己的线程，我们可以调用“</span><span>QueueUserAPC()</span><span style="font-family:宋体;">”函数来劫持目标</span><span>/</span><span style="font-family:宋体;">远程进程中一个已存在的线程；即，调用该函数将在指定线程的</span><span>APC</span><span style="font-family:宋体;">队列中添加一个异步过程调用。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">我们可以使用一个真实的</span><span>APC</span><span style="font-family:宋体;">回调函数，而不使用“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”。事实上参数可以是指向我们想要注入的</span><span>DLL</span><span style="font-family:宋体;">文件名称的指针，具体代码如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">dwResult&nbsp;=&nbsp;QueueUserAPC((PAPCFUNC)pfnThreadRtn,&nbsp;hThread,&nbsp;(</code><code class="cpp color1 bold">ULONG_PTR</code><code class="cpp plain">)pszLibFileRemote);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">如果你想试用这种技术，那么有一点你可能注意到了，即它与微软</span><span>Windows</span><span style="font-family:宋体;">操作系统执行</span><span>APC</span><span style="font-family:宋体;">的方式有关。没有能够查看</span><span>APC</span><span style="font-family:宋体;">队列的调度器，这意味着只有线程设置成可唤醒模式才能够检查队列。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">因此，我们基本上劫持每一个单独的线程，具体代码如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">BOOL</code>&nbsp;<code class="cpp plain">bResult&nbsp;=&nbsp;Thread32First(hSnapshot,&nbsp;&amp;threadEntry);</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code>&nbsp;<code class="cpp plain">(bResult)</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">bResult&nbsp;=&nbsp;Thread32Next(hSnapshot,&nbsp;&amp;threadEntry);</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code>&nbsp;<code class="cpp plain">(bResult)</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code>&nbsp;<code class="cpp plain">(threadEntry.th32OwnerProcessID&nbsp;==&nbsp;dwProcessId)</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">threadId&nbsp;=&nbsp;threadEntry.th32ThreadID;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wprintf(TEXT(</code><code class="cpp string">"[+]&nbsp;Using&nbsp;thread:&nbsp;%i\n"</code><code class="cpp plain">),&nbsp;threadId);</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">HANDLE</code>&nbsp;<code class="cpp plain">hThread&nbsp;=&nbsp;OpenThread(THREAD_SET_CONTEXT,&nbsp;FALSE,&nbsp;threadId);</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code>&nbsp;<code class="cpp plain">(hThread&nbsp;==&nbsp;NULL)</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wprintf(TEXT(</code><code class="cpp string">"[-]&nbsp;Error:&nbsp;Can't&nbsp;open&nbsp;thread.&nbsp;Continuing&nbsp;to&nbsp;try&nbsp;other&nbsp;threads...\n"</code><code class="cpp plain">));</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;<code class="cpp plain">dwResult&nbsp;=&nbsp;QueueUserAPC((PAPCFUNC)pfnThreadRtn,&nbsp;hThread,&nbsp;(</code><code class="cpp color1 bold">ULONG_PTR</code><code class="cpp plain">)pszLibFileRemote);</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code>&nbsp;<code class="cpp plain">(!dwResult)</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wprintf(TEXT(</code><code class="cpp string">"[-]&nbsp;Error:&nbsp;Couldn't&nbsp;call&nbsp;QueueUserAPC&nbsp;on&nbsp;thread&gt;&nbsp;Continuing&nbsp;to&nbsp;try&nbsp;othrt&nbsp;threads...\n"</code><code class="cpp plain">));</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">wprintf(TEXT(</code><code class="cpp string">"[+]&nbsp;Success:&nbsp;DLL&nbsp;injected&nbsp;via&nbsp;CreateRemoteThread().\n"</code><code class="cpp plain">));</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CloseHandle(hThread);</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">这样做的理由主要是期望其中一个线程会被设为可唤醒模式。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">另外，使用“双脉冲星”（网址：</span><span><a href="https://countercept.com/our-thinking/doublepulsar-usermode-analysis-generic-reflective-dll-loader/">https://countercept.com/our-thinking/doublepulsar-usermode-analysis-generic-reflective-dll-loader/</a></span><span style="font-family:宋体;">，</span><span>DOUBLEPULSAR </span><span style="font-family:宋体;">用户模式分析：通用反射</span><span>DLL</span><span style="font-family:宋体;">加载器）工具分析学习这项技术，是个很好的办法。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">完整代码请参阅源文件“</span><span>t_QueueUserAPC.cpp</span><span style="font-family:宋体;">”。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">（</span><span>4</span><span style="font-family:宋体;">）</span><span>SetWindowsHookEx()</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">使用这项技术的首要工作是，我们需要理解在微软</span><span>Windows</span><span style="font-family:宋体;">操作系统中劫持的工作原理。本质上，劫持技术是拦截并干预事件的一种方式。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">正如你所猜想的那样，有很多种不同类型的劫持技术。最通用的一种可能是</span><span>WH_KEYBOARD</span><span style="font-family:宋体;">和</span><span>WH_MOUSE</span><span style="font-family:宋体;">消息拦截；没错，它们可被用于监控键盘与鼠标的输入。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">函数“</span><span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms644990%28v=vs.85%29.aspx">SetWindowsHookEx()</a></span><span style="font-family:宋体;">”将一个应用程序定义的拦截例程安装到一个拦截链表中。函数原型和参数定义如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">HHOOK</code>&nbsp;<code class="cpp plain">WINAPI&nbsp;SetWindowsHookEx(</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">int</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code class="cpp plain">idHook,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;HOOKPROC&nbsp;&nbsp;lpfn,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">HINSTANCE</code>&nbsp;<code class="cpp plain">hMod,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">_In_&nbsp;</code><code class="cpp color1 bold">DWORD</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code class="cpp plain">dwThreadId</code></div><div class="line number6 index5 alt1"><code class="cpp plain">);</code></div><div class="line number7 index6 alt2"><code class="cpp plain">idHook&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number8 index7 alt1"><code class="cpp plain">类型：整型（</code><code class="cpp color1 bold">int</code><code class="cpp plain">）</code></div><div class="line number9 index8 alt2"><code class="cpp plain">待安装拦截例程的类型。（…）</code></div><div class="line number10 index9 alt1"><code class="cpp plain">lpfn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number11 index10 alt2"><code class="cpp plain">类型：拦截例程函数类型（HOOKPROC）</code></div><div class="line number12 index11 alt1"><code class="cpp plain">指向拦截例程的指针。（…）</code></div><div class="line number13 index12 alt2"><code class="cpp plain">hMod&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number14 index13 alt1"><code class="cpp plain">类型：实例句柄（</code><code class="cpp color1 bold">HINSTANCE</code><code class="cpp plain">）</code></div><div class="line number15 index14 alt2"><code class="cpp plain">一个DLL模块的句柄，该DLL模块中包含lpfn参数所指向的拦截例程。（…）</code></div><div class="line number16 index15 alt1"><code class="cpp plain">dwThreadId&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[输入参数]</code></div><div class="line number17 index16 alt2"><code class="cpp plain">类型：双字（</code><code class="cpp color1 bold">DWORD</code><code class="cpp plain">）</code></div><div class="line number18 index17 alt1"><code class="cpp plain">拦截例程所关联的线程的标识符。（…）</code></div></div></td></tr></tbody></table><p>&nbsp; &nbsp; MSDN中有一段很有趣的备注如下：</p><p>&nbsp; &nbsp; “SetWindowsHookEx函数可被用于向另一个进程注入DLL文件。一个32位的DLL文件不能注入一个64位的进程，反之亦然。如果一个应用程序需要在其他进程中使用劫持技术，那么就要求一个32（64）位的应用程序调用SetWindowsHookEx函数来将一个32（64）位的DLL文件注入到一个32（64）位的进程中。32位和64位DLL文件的名称必须不同。”</p><p>&nbsp; &nbsp; 记住以上内容。</p><p>&nbsp; &nbsp; 以下代码是实现的简要过程。</p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">GetWindowThreadProcessId(targetWnd,&nbsp;&amp;dwProcessId)</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">HHOOK</code>&nbsp;<code class="cpp plain">handle&nbsp;=&nbsp;SetWindowsHookEx(WH_KEYBOARD,&nbsp;addr,&nbsp;dll,&nbsp;threadID);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">我们需要理解的是，每一个发生的事件都要遍历拦截链表，该链表包含一系列响应事件的例程。“</span><span>SetWindowsHookEx()</span><span style="font-family:宋体;">”函数的设置工作基本上就是如何将我们自己的拦截例程植入拦截链表中。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">以上代码用到了待安装的劫持消息类型（</span><span>WH_KEYBOARD</span><span style="font-family:宋体;">）例程指针，包含例程的</span><span>DLL</span><span style="font-family:宋体;">模块句柄，以及劫持所关联的线程标识号。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">为了获取例程指针，我们需要首先调用“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”函数加载</span><span>DLL</span><span style="font-family:宋体;">文件，然后调用“</span><span>SetWindowsHookEx()</span><span style="font-family:宋体;">”函数，并等待我们所需的事件发生（本文中该事件是指按键）；一旦事件发生我们的</span><span>DLL</span><span style="font-family:宋体;">就会被执行。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">注意，正如我们在维基解密（网址：</span><span><a href="https://wikileaks.org/ciav7p1/cms/page_6062133.html">https://wikileaks.org/ciav7p1/cms/page_6062133.html</a></span><span style="font-family:宋体;">）中所看到的，就连联邦调查局的人员也有可能用到“</span><span>SetWindowsHookEx()</span><span style="font-family:宋体;">”函数。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">完整代码请参阅源文件“</span><span>t_SetWindowsHookEx.cpp</span><span style="font-family:宋体;">”。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">（</span><span>5</span><span style="font-family:宋体;">）</span><span>RtlCreateUserThread()</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">“</span><span><a href="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FExecutable%20Images%2FRtlCreateUserThread.html">RtlCreateUserThread()</a></span><span style="font-family:宋体;">”是一个未公开的</span><span>API</span><span style="font-family:宋体;">函数。它的设置工作几乎和“</span><span>CreateRemoteThread()</span><span style="font-family:宋体;">”函数相同，相应的也和“</span><span>NtCreateThreadEx()</span><span style="font-family:宋体;">”函数相同。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">实际上，“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”调用“</span><span>NtCreateThreadEx()</span><span style="font-family:宋体;">”，这意味着“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”是“</span><span>NtCreateThreadEx()</span><span style="font-family:宋体;">”的一个小型封装函数；因此，这个函数并没有新的内容。然而，我们可能只是单纯地想使用“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”而不用“</span><span>NtCreateThreadEx()</span><span style="font-family:宋体;">”。哪怕之后发生变动，我们的“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”仍能正常工作。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">正如你所知道的，不同于其他工具，</span><span><a href="http://blog.gentilkiwi.com/mimikatz">mimikatz</a></span><span style="font-family:宋体;">工具和</span><span>Metasploit</span><span style="font-family:宋体;">平台都用到了“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”。如果你对此感兴趣，请参阅网址：</span><span><a href="https://github.com/gentilkiwi/mimikatz/blob/d5676aa66cb3f01afc373b0a2f8fcc1a2822fd27/modules/kull_m_remotelib.c#L59">https://github.com/gentilkiwi/mimikatz/blob/d5676aa66cb3f01afc373b0a2f8fcc1a2822fd27/modules/kull_m_remotelib.c#L59</a></span><span style="font-family:宋体;">和网址：</span><span><a href="https://github.com/rapid7/meterpreter/blob/6d43284689240f4261cae44a47f0fb557c1dde27/source/common/arch/win/remote_thread.c">https://github.com/rapid7/meterpreter/blob/6d43284689240f4261cae44a47f0fb557c1dde27/source/common/arch/win/remote_thread.c</a></span><span style="font-family:宋体;">。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">因此，如果</span><span>mimikatz</span><span style="font-family:宋体;">工具和</span><span>Metasploit</span><span style="font-family:宋体;">平台都使用“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”函数，那么（是的，他们了解自己的处理对象）听从他们的“建议”，使用“</span><span>RtlCreateUserThread()</span><span style="font-family:宋体;">”；特别是你计划做一项相比于简单的“</span><span>injectAllTheThings</span><span style="font-family:宋体;">”工程来说更认真的项目。</span></p><p style="text-indent:28px;"><a href="http://bbs.pediy.com/thread-220405.htm"></a><a href="http://bbs.pediy.com/thread-220405.htm"><span style="font-family:宋体;">完整代码请参阅源文件“</span><span>t_RtlCreateUserThread.cpp</span></a><span style="font-family:宋体;">”。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">（</span><span>6</span><span style="font-family:宋体;">）</span><span>SetThreadContext()</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">实际上这是一种非常酷的方法：通过在目标</span><span>/</span><span style="font-family:宋体;">远程进程中分配一块内存区域，向目标</span><span>/</span><span style="font-family:宋体;">远程进程注入一段特别构造的代码，这段代码的用途是加载</span><span>DLL</span><span style="font-family:宋体;">模块。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">以下是</span><span>32</span><span style="font-family:宋体;">位环境下的代码。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">0x68,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;0xDEADBEEF&nbsp;(为返回地址占位)</code></div><div class="line number2 index1 alt1"><code class="cpp plain">0x9c,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pushfd&nbsp;(保存标志和寄存器)</code></div><div class="line number3 index2 alt2"><code class="cpp plain">0x60,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pushad</code></div><div class="line number4 index3 alt1"><code class="cpp plain">0x68,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;0xDEADBEEF&nbsp;(为DLL路径名称占位)</code></div><div class="line number5 index4 alt2"><code class="cpp plain">0xb8,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;mov&nbsp;eax,&nbsp;0xDEADBEEF&nbsp;(为LoadLibrary函数占位)</code></div><div class="line number6 index5 alt1"><code class="cpp plain">0xff,&nbsp;0xd0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;call&nbsp;eax&nbsp;(调用LoadLibrary函数)</code></div><div class="line number7 index6 alt2"><code class="cpp plain">0x61,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;popad&nbsp;(恢复标志和寄存器)</code></div><div class="line number8 index7 alt1"><code class="cpp plain">0x9d,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;popfd</code></div><div class="line number9 index8 alt2"><code class="cpp plain">0xc3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;ret</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">对于</span><span>64</span><span style="font-family:宋体;">位环境，实际上我没有找到任何完整的工作代码，因此我简单写了我自己的代码，如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">0x50,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rax&nbsp;(保存RAX寄存器)</code></div><div class="line number2 index1 alt1"><code class="cpp plain">0x48,&nbsp;0xB8,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;</code><code class="cpp comments">//&nbsp;mov&nbsp;rax,&nbsp;0CCCCCCCCCCCCCCCCh&nbsp;(为返回地址占位)</code></div><div class="line number3 index2 alt2"><code class="cpp plain">0x9c,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pushfq</code></div><div class="line number4 index3 alt1"><code class="cpp plain">0x51,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rcx</code></div><div class="line number5 index4 alt2"><code class="cpp plain">0x52,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rdx</code></div><div class="line number6 index5 alt1"><code class="cpp plain">0x53,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rbx</code></div><div class="line number7 index6 alt2"><code class="cpp plain">0x55,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rbp</code></div><div class="line number8 index7 alt1"><code class="cpp plain">0x56,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rsi</code></div><div class="line number9 index8 alt2"><code class="cpp plain">0x57,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;rdi</code></div><div class="line number10 index9 alt1"><code class="cpp plain">0x41,&nbsp;0x50,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r8</code></div><div class="line number11 index10 alt2"><code class="cpp plain">0x41,&nbsp;0x51,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r9</code></div><div class="line number12 index11 alt1"><code class="cpp plain">0x41,&nbsp;0x52,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r10</code></div><div class="line number13 index12 alt2"><code class="cpp plain">0x41,&nbsp;0x53,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r11</code></div><div class="line number14 index13 alt1"><code class="cpp plain">0x41,&nbsp;0x54,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r12</code></div><div class="line number15 index14 alt2"><code class="cpp plain">0x41,&nbsp;0x55,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r13</code></div><div class="line number16 index15 alt1"><code class="cpp plain">0x41,&nbsp;0x56,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r14</code></div><div class="line number17 index16 alt2"><code class="cpp plain">0x41,&nbsp;0x57,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;push&nbsp;r15</code></div><div class="line number18 index17 alt1"><code class="cpp plain">0x68,0xef,0xbe,0xad,0xde,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;fastcall调用约定</code></div><div class="line number19 index18 alt2"><code class="cpp plain">0x48,&nbsp;0xB9,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;</code><code class="cpp comments">//&nbsp;mov&nbsp;rcx,&nbsp;0CCCCCCCCCCCCCCCCh&nbsp;(为DLL路径名称占位)</code></div><div class="line number20 index19 alt1"><code class="cpp plain">0x48,&nbsp;0xB8,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;0xCC,&nbsp;</code><code class="cpp comments">//&nbsp;mov&nbsp;rax,&nbsp;0CCCCCCCCCCCCCCCCh&nbsp;(为LoadLibrary函数占位)</code></div><div class="line number21 index20 alt2"><code class="cpp plain">0xFF,&nbsp;0xD0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;call&nbsp;rax&nbsp;(调用LoadLibrary函数)</code></div><div class="line number22 index21 alt1"><code class="cpp plain">0x58,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;dummy</code></div><div class="line number23 index22 alt2"><code class="cpp plain">0x41,&nbsp;0x5F,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r15</code></div><div class="line number24 index23 alt1"><code class="cpp plain">0x41,&nbsp;0x5E,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r14</code></div><div class="line number25 index24 alt2"><code class="cpp plain">0x41,&nbsp;0x5D,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r13</code></div><div class="line number26 index25 alt1"><code class="cpp plain">0x41,&nbsp;0x5C,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r12</code></div><div class="line number27 index26 alt2"><code class="cpp plain">0x41,&nbsp;0x5B,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r11</code></div><div class="line number28 index27 alt1"><code class="cpp plain">0x41,&nbsp;0x5A,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r10</code></div><div class="line number29 index28 alt2"><code class="cpp plain">0x41,&nbsp;0x59,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r9</code></div><div class="line number30 index29 alt1"><code class="cpp plain">0x41,&nbsp;0x58,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;r8</code></div><div class="line number31 index30 alt2"><code class="cpp plain">0x5F,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rdi</code></div><div class="line number32 index31 alt1"><code class="cpp plain">0x5E,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rsi</code></div><div class="line number33 index32 alt2"><code class="cpp plain">0x5D,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rbp</code></div><div class="line number34 index33 alt1"><code class="cpp plain">0x5B,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rbx</code></div><div class="line number35 index34 alt2"><code class="cpp plain">0x5A,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rdx</code></div><div class="line number36 index35 alt1"><code class="cpp plain">0x59,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rcx</code></div><div class="line number37 index36 alt2"><code class="cpp plain">0x9D,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;popfq</code></div><div class="line number38 index37 alt1"><code class="cpp plain">0x58,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;pop&nbsp;rax</code></div><div class="line number39 index38 alt2"><code class="cpp plain">0xC3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;ret</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">在我们想目标进程注入这段代码之前，以下占位符需要修改填充：</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">·返回地址（代码桩执行完毕之后，线程恢复应回到的地址）</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">·</span><span>DLL</span><span style="font-family:宋体;">路径名称</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">·</span><span>LoadLibrary()</span><span style="font-family:宋体;">函数地址</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">而这也是进行劫持，挂起，注入和恢复线程这一系列操作的时机。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">我们需要附加到目标</span><span>/</span><span style="font-family:宋体;">远程进程，之后当然是在目标</span><span>/</span><span style="font-family:宋体;">远程进程中分配内存。注意，我们需要以读写权限分配内存，以便操作</span><span>DLL</span><span style="font-family:宋体;">路径名称和用于加载</span><span>DLL</span><span style="font-family:宋体;">文件的封装代码。具体代码如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp color1 bold">LPVOID</code>&nbsp;<code class="cpp plain">lpDllAddr&nbsp;=&nbsp;VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;dwSize,&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);</code></div><div class="line number2 index1 alt1"><code class="cpp plain">stub&nbsp;=&nbsp;VirtualAllocEx(hProcess,&nbsp;NULL,&nbsp;stubLen,&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">之后，我们需要获取一个运行于目标</span><span>/</span><span style="font-family:宋体;">远程进程之上的线程上下文（即我们将要注入封装代码的目标线程）。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">我们调用函数“</span><span>getThreadID()</span><span style="font-family:宋体;">”来找到线程，你可以在文件“</span><span>auxiliary.cpp</span><span style="font-family:宋体;">”中找到该函数。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">有了线程标识号之后，我们需要设置线程上下文。具体代码如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">hThread&nbsp;=&nbsp;OpenThread((THREAD_GET_CONTEXT&nbsp;|&nbsp;THREAD_SET_CONTEXT&nbsp;|&nbsp;THREAD_SUSPEND_RESUME),&nbsp;</code><code class="cpp keyword bold">false</code><code class="cpp plain">,&nbsp;threadID);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">然后，我们需要挂起线程来获取其上下文；一个线程的上下文是指其寄存器的状态，我们格外关注的是</span><span>EIP/RIP</span><span style="font-family:宋体;">寄存器（根据需要也可以称其为</span><span>IP</span><span style="font-family:宋体;">——</span><span>instruction pointer</span><span style="font-family:宋体;">，指令指针）。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">由于线程已被挂起，所以我们可以改变</span><span>EIP/RIP</span><span style="font-family:宋体;">寄存器的值，控制线程在不同的路径上（我们的代码区域）继续执行。具体代码如下所示。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  cpp"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">ctx.ContextFlags&nbsp;=&nbsp;CONTEXT_CONTROL;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">GetThreadContext(hThread,&nbsp;&amp;ctx);</code></div><div class="line number3 index2 alt2"><code class="cpp color1 bold">DWORD64</code>&nbsp;<code class="cpp plain">oldIP&nbsp;=&nbsp;ctx.Rip;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp plain">ctx.Rip&nbsp;=&nbsp;(</code><code class="cpp color1 bold">DWORD64</code><code class="cpp plain">)stub;</code></div><div class="line number6 index5 alt1"><code class="cpp plain">ctx.ContextFlags&nbsp;=&nbsp;CONTEXT_CONTROL;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number8 index7 alt1"><code class="cpp plain">WriteProcessMemory(hProcess,&nbsp;(</code><code class="cpp keyword bold">void</code>&nbsp;<code class="cpp plain">*)stub,&nbsp;&amp;sc,&nbsp;stubLen,&nbsp;NULL);&nbsp;</code><code class="cpp comments">//&nbsp;write&nbsp;code&nbsp;cave</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;</code>&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp plain">SetThreadContext(hThread,&nbsp;&amp;ctx);</code></div><div class="line number11 index10 alt2"><code class="cpp plain">ResumeThread(hThread);</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">因此，我们中断线程，获取上下文，并从上下文中提取</span><span>EIP/RIP</span><span style="font-family:宋体;">值；保存的旧值用于在注入代码执行完成时恢复线程的执行流程。新的</span><span>EIP/RIP</span><span style="font-family:宋体;">值设置为我们注入的代码位置。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">然后我们用返回地址，</span><span>DLL</span><span style="font-family:宋体;">路径名称地址和“</span><span>LoadLibrary</span><span style="font-family:宋体;">”函数地址填充所有的占位符。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">线程开始执行的时候，我们的</span><span>DLL</span><span style="font-family:宋体;">文件将被加载；而当注入代码执行完成时，执行流程将返回县城挂起点，并从此恢复线程的正常执行流程。</span></p><p style="text-indent:28px;"><span style="font-family:宋体;">如果你想要调试这种技术方法来学习练习，以下是操作流程。启动你想要注入的应用程序，在此我们以“</span><span>notepad.exe</span><span style="font-family:宋体;">”为例。使用“</span><span>x64dbg</span><span style="font-family:宋体;">”调试工具来运行“</span><span>injectAllTheThings_64.exe</span><span style="font-family:宋体;">”，如下图所示。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/1.png" style="width: 909.203px; height: auto;"></p><p style="text-indent:28px;"><span style="font-family:宋体;">使用以下命令（根据你的实际环境来调整）。</span></p><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  bash"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash string">"C:\Users\rui\Documents\Visual&nbsp;Studio&nbsp;2013\Projects\injectAllTheThings\bin\injectAllTheThings_64.exe"</code>&nbsp;<code class="bash plain">-t&nbsp;6&nbsp;notepad.exe&nbsp;</code><code class="bash string">"c:\Users\rui\Documents\Visual&nbsp;Studio&nbsp;2013\Projects\injectAllTheThings\bin\dllmain_64.dll"</code></div></div></td></tr></tbody></table><p style="text-indent:28px;"><span style="font-family:宋体;">在调用“</span><span>WriteProcessMemory()</span><span style="font-family:宋体;">”函数处设下断点，如下图所示。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/2.png" style="width: 909.203px; height: auto;"></p><p style="text-indent:28px;"><span style="font-family:宋体;">继续运行程序，当运行到断点处时，注意寄存器</span><span>RDX</span><span style="font-family:宋体;">中的内存地址，如图所示。如果你对为什么这里需要关注</span><span>RDX</span><span style="font-family:宋体;">有疑问，请去查阅</span><span>x64</span><span style="font-family:宋体;">环境下的调用约定；搞清楚再回来继续学习。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/3.png" style="width: 909.203px; height: auto;"></p><p>&nbsp; &nbsp; 单步步过（快捷键F8）调用“WriteProcessMemory()”函数的过程，开启x64dbg工具的另一个实例，并将其附加到“notepad.exe”进程通过快捷键“Ctrl+g”调到之前复制的地址（即RDX寄存器中的内存地址）处，你将看到我们的代码区域程序集，如下图所示。</p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/4.png" style="width: 909.203px; height: auto;"></p><p style="text-indent:28px;"><span style="font-family:宋体;">很酷吧？现在在</span><span>Shellcode</span><span style="font-family:宋体;">代码起始处设下断点。转向“</span><span>injectAllTheThings</span><span style="font-family:宋体;">”调试进程，并运行程序。我们的断点被成功断下，如下图所示；现在我们可以步过代码，并分析这段代码的功能。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/5.png" style="width: 909.203px; height: auto;"></p><p style="text-indent:28px;"><span style="font-family:宋体;">当我们调用“</span><span>LoadLibrary()</span><span style="font-family:宋体;">”函数时，我们的</span><span>DLL</span><span style="font-family:宋体;">文件成功加载，如下图所示。</span></p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/6.png" style="width: 909.203px; height: auto;"></p><p>&nbsp; &nbsp; 太棒了~</p><p>&nbsp; &nbsp; 我们的Shellcode代码将返回到之前保存的RIP地址处，“notepad.exe”进程将恢复执行。</p><p>&nbsp; &nbsp; 完整代码请参阅源文件“t_suspendInjectResume.cpp”。</p><p>&nbsp; &nbsp; （7）反射DLL注入</p><p>&nbsp; &nbsp; 我将Stephen Fewer（这项技术的先驱）的代码也整合到了这个“injectAllTheThings”工程中，同时还构建了一个反射DLL文件用于这项技术。注意，我们要注入的DLL文件必须使用适当的包含和选项来进行编译，这样它才能与反射DLL注入技术相匹配。</p><p>&nbsp; &nbsp; 反射DLL注入技术通过将整个DLL文件复制到内存中的方式来生效，因此它避免了向进程注册DLL模块这一行为。所有的繁琐工作都已完成。要在DLL模块加载到内存时获取其入口点，我们只需要使用Stephen Fewer的代码；他的工程中所包含的“LoadRemoteLibrary()”函数为我们完成这项工作。我们使用“GetReflectLoaderOffset()”函数来确定在我们进程内存中的偏移，然后我们将偏移加上目标/远程进程（即我们写入DLL模块的进程）的内存基址，将该结果作为执行起始点。</p><p>&nbsp; &nbsp; 太复杂？好吧，可能有点儿；以下是实现上述过程的4个主要步骤。</p><p>&nbsp; &nbsp; 1.将DLL文件头部写入内存</p><p>&nbsp; &nbsp; 2.将每个区块写入内存（通过解析区块表）</p><p>&nbsp; &nbsp; 3.检查输入表，并加载任何引用的DLL文件</p><p>&nbsp; &nbsp; 4.调用DLLMain函数的入口点</p><p>&nbsp; &nbsp; 相比于其他方法，这种技术有很好的隐蔽性，主要被用于Metasploit平台。</p><p>&nbsp; &nbsp; 如果你想要了解更多，请前往官方GitHub库；还想要阅读Stephen Fewer的文章的话，请参阅网址：http://www.harmonysecurity.com/files/HS-P005_ReflectiveDllInjection.pdf。</p><p>&nbsp; &nbsp; 还可以参阅“MemoryModule”项目的作者Joachim Bauch所写的“从内存中加载DLL文件”，以及一篇好文章“不调用LoadLibrary()函数‘手动’加载32位/64位DLL文件”。</p><p>&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; <strong>代码</strong></p><p>&nbsp; &nbsp; 还有一些模糊复杂的注入方法，因此我未来将对“injectAllTheThings”工程进行更新。其中某些最有趣的技术包括：</p><p>&nbsp; &nbsp; •“双脉冲星”工具所用到的技术</p><p>&nbsp; &nbsp; •网友@zerosum0x0所编写的工具，使用SetThreadContext()和NtContinue()实现的反射DLL注入，详细描述参见网址：https://zerosum0x0.blogspot.co.uk/2017/07/threadcontinue-reflective-injection.html，可用代码详见网址：https://github.com/zerosum0x0/ThreadContinue。</p><p>&nbsp; &nbsp; 以上我所描述的所有技术，都在一个单独的工程中实现了，我将其放在GitHub库中；其中还包括每种技术所需的DLL文件。为了便于理解，下表简单介绍了所实现的方法和具体用法。</p><p><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/412913_fyuz7rkc9uh9miv.png" width="625" height="291">&nbsp; &nbsp;&nbsp;</p><p>&nbsp; &nbsp; 需要说明的是，从安全角度出发，应该坚持使用injectAllTheThings_32.exe注入32位进程，或者injectAllTheThings_64.exe来注入64位进程；尽管你也可以使用injectAllTheThings_64.exe来注入32位进程。而实际上我并没有这样实现，但可能之后我会尝试一下，具体请参考以下网址：http://blog.rewolf.pl/blog/?p=102。参考网址中的技术基本上就是Metasploit平台上“smart_migrate”工具所用到的，详见网址：https://github.com/rapid7/meterpreter/blob/5e24206d510a48db284d5f399a6951cd1b4c754b/source/common/arch/win/i386/base_inject.c。</p><p>&nbsp; &nbsp; 整个工程的代码（包括DLL文件）都在GitHub库中。代码以32位/64位环境编译，包含或不包含调试信息都可以。</p><p><br></p><p>&nbsp; &nbsp; <strong>参考</strong></p><p>&nbsp; &nbsp; ·http://www.nologin.org/Downloads/Papers/remote-library-injection.pdf</p><p>&nbsp; &nbsp; ·https://warroom.securestate.com/dll-injection-part-1-setwindowshookex/</p><p>&nbsp; &nbsp; ·https://warroom.securestate.com/dll-injection-part-2-createremotethread-and-more/</p><p>&nbsp; &nbsp; ·http://blog.opensecurityresearch.com/2013/01/windows-dll-injection-basics.html</p><p>&nbsp; &nbsp; ·http://resources.infosecinstitute.com/using-createremotethread-for-dll-injection-on-windows/</p><p>&nbsp; &nbsp; ·http://securityxploded.com/ntcreatethreadex.php</p><p>&nbsp; &nbsp; ·https://www.codeproject.com/Tips/211962/Bit-Injection-Cave</p><p>&nbsp; &nbsp; ·http://www.blizzhackers.cc/viewtopic.php?p=2483118</p><p>&nbsp; &nbsp; ·http://resources.infosecinstitute.com/code-injection-techniques/</p><p>&nbsp; &nbsp; ·Windows via C/C++ 5th Edition</p><p><br></p><p><br></p><p><br></p><p><br></p><p>&nbsp; &nbsp; 原文链接：http://blog.deniable.org/blog/2017/07/16/inject-all-the-things/</p><p>&nbsp; &nbsp; 本文由 &nbsp;看雪翻译小组 &nbsp;木无聊偶 &nbsp;编译</p><p>&nbsp; &nbsp; 转载请注明来源</p><p>										</p><p>										</p>				
				
								
				
						</div>
			<div>
						</div>
		</div>

		<style>
			.card_collection { vertical-align: middle; display: inline-block; border: 1px solid #eee; background: #EEEEEE; padding: 0px 8px; border-radius: 5px; }
			.card_collection p { margin-bottom: 0px;font-size: 12px;}
			.card_collection p a { text-decoration: none; }
			.alipay-bg { width: 60px;height: 20px;display: inline-block;vertical-align: middle;background: url(view/img/reward_alipay.png) 0 0 no-repeat;}
		</style>
		<div class="card" style="background:#F9F9F9;text-align:center;padding:5px 0px;">
			<div style="width:auto;display:inline-block;">
				<div class="card_collection" style="width: 70px; height: 65px;line-height:30px">
					<p><a href="http://bbs.pediy.com/user-collection.htm"><b id="likes">22</b></a></p>
					<p id="favorite">
						<a href="javascript:void(0)" title="点我收藏">
														<i class="icon-star-o"></i>&nbsp;收藏
													</a>
					</p>
				</div>
				
				<div class="card_collection">
					<a href="javascript:void(0);" class="modal-title" id="exampleModalLabel" data-toggle="modal" data-target=".reward"><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/dashang.png" alt="赞赏" style="width:60px;vertical-align: middle;" title="现金赞赏支持"></a>
				</div>

				<div class="card_collection">
					<img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bbs_qrcode-http_3A_2F_2Fbbs_2epediy_2ecom_2Fthread_2d220405_2ehtm.htm" alt="二维码" style="width:60px;vertical-align: middle; ">
				</div>
			</div>
		</div>
		
		                <div class="card text-center small" style="padding:5px 15px;">
                        <div class="row p-b-sm">
                                <div class="p-t-sm">本主题帖已收到 <span class="text-warning text-bold">1</span> 次赞赏，累计<span class="text-danger text-bold">￥5.00</span></div>
                                <div class="col-lg-12 text-left">
                                                                                <a href="http://bbs.pediy.com/user-733834.htm" data-toggle="tooltip" data-placement="top" data-original-title="哆啦咪，￥5.00" title="">
                                        <img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/733834.png" class="avatar-xs m-t-sm m-l-xs" style="width: 1.6rem;height: 1.6rem;border-radius: 1.6rem;">
                                        </a>
                                                                        </div>
                        </div>
                </div>

                <!--赞赏支持-->
                <div class="modal fade reward" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                            </button>
                                            <h4 class="modal-title" id="exampleModalLabel">赞赏</h4>
                                        </div>
                                        <form action="http://bbs.pediy.com/thread-220405.htm" method="post" id="pay_kx" onsubmit="return topay()">
                                                <div class="modal-body text-center">
                                                        <div class="form-group">
                                                                <input name="ureward" type="hidden" value="412913">
                                                                <input type="hidden" name="reward_articleid" value="220405">
                                                                <div class="avatar m-b-2 m-t-sm" style="width: 70px;height: 70px;display: inline-block;">
                                                                    <img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/dashang.png" alt="100">
                                                                </div>
                                                                
                                                                <div class="text-center m-b-2">
                                                                    <div class="" data-toggle="buttons">
                                                                        <label class="btn btn-outline-danger active" style="width:120px">
                                                                            <input type="radio" value="1" name="reward_rmbs" id="option1" autocomplete="off" checked="">1 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="2" name="reward_rmbs" id="option2" autocomplete="off">2 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="5" name="reward_rmbs" id="option3" autocomplete="off">5 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="10" name="reward_rmbs" id="option4" autocomplete="off">10 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="20" name="reward_rmbs" id="option5" autocomplete="off">20 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="50" name="reward_rmbs" id="option6" autocomplete="off">50 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="100" name="reward_rmbs" id="option7" autocomplete="off">100 元
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" value="200" name="reward_rmbs" id="option8" autocomplete="off">200 元
                                                                        </label>
                                                                    </div>
                                                                </div>

                                                                <div class="text-center">
                                                                    <label id="alipay_lab">
                                                                        <span>支付方式：</span>
                                                                        <input type="radio" value="1" checked="checked" name="reward_type" style="display:inline">
                                                                        <span class="alipay-bg"></span>
                                                                    </label>
                                                                   <!--  <label class="m-l-1">
                                                                        <input type="radio" value="3" name="reward_type">
                                                                        <i class="icon icon-weixin" style="font-size:17px;color:#49BE38"></i> 微信支付
                                                                    </label> -->
                                                                                                                                        <label class="m-l-1"><input type="radio" value="2" name="reward_type"> 余额（余额 ¥0.00）</label>
                                                                                                                                    </div>
                                                        </div>
                                                </div>

                                                <div class="modal-footer">
                                                        <button id="pay_submit" type="submit" class="btn btn-primary btn-pay kx-pay" data-loading-text="正在提交...">立即支付</button>
                                                </div>
                                        <input type="hidden" name="3xf8gotid0ufnbe9" value="3xf8gotid0ufnbe9"><input type="hidden" name="__anti_xss__" value="1502841785_6bee1b7c8af19356f40b4c94064d1a63"></form>
                                </div>
                        </div>
                </div>		<div class="card post p-a-sm" id="point_undefined">
			<table class="table postlist m-b-0">
				<thead>
					<tr>
						<th colspan="2" class="p-a-0  p-b-sm">
							<dl class="row">
								<dt>
									<b>最新回复</b> (<span class="posts">9</span>)
								</dt>
								<dd style="text-align: right;">
									
									
																		
								</dd>
							</dl>
						</th>
					</tr>
				</thead>
				<tbody>
				
													
				
																																			
					<tr class="post" pid="1491091" id="point_1491091">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-674668.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/674668.png">
							</a>
							<div>
								<span class="group group-102 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2015-4 <br>
								帖子：375 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-674668.htm">我是谁！</a>
									</span>
									
									<span class="date text-grey m-l-sm">2天前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491091" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491091" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">2</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								不错不错<br>																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491100" id="point_1491100">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-13783.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/avatar.png">
							</a>
							<div>
								<span class="group group-103 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2004-12 <br>
								帖子：368 <br>-->

																<span class="icon-diamond text-danger" title="精华数"></span><span class="text-bold text-danger"> 1</span>
								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-13783.htm">lhglhg</a>
									</span>
									
									<span class="date text-grey m-l-sm">2天前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491100" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491100" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">3</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								代码哪里有下载？																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491105" id="point_1491105">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-407019.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/407019.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2011-2 <br>
								帖子：21 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-407019.htm">zyla</a>
									</span>
									
									<span class="date text-grey m-l-sm">2天前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491105" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491105" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">4</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								感谢科普																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491112" id="point_1491112">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-643156.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/643156.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2014-7 <br>
								帖子：41 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-643156.htm">mihacker</a>
									</span>
									
									<span class="date text-grey m-l-sm">2天前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491112" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491112" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">5</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								&nbsp; &nbsp; &nbsp; 好文！Git上的代码留着																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491114" id="point_1491114">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-732951.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/avatar.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2016-10 <br>
								帖子：5 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-732951.htm">脚印</a>
									</span>
									
									<span class="date text-grey m-l-sm">2天前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491114" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491114" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">6</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								马克																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491233" id="point_1491233">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-2205.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/avatar.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2004-5 <br>
								帖子：304 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-2205.htm">rock</a>
									</span>
									
									<span class="date text-grey m-l-sm">22小时前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491233" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491233" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">7</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								楼主放个WORD版本，下载收藏																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491309" id="point_1491309">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-7267.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/avatar.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2004-8 <br>
								帖子：137 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-7267.htm">jgs</a>
									</span>
									
									<span class="date text-grey m-l-sm">14小时前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491309" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491309" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">8</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								看着，等着，等能够消化的时候再来看																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491330" id="point_1491330">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-678772.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/678772.png">
							</a>
							<div>
								<span class="group group-104 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2015-5 <br>
								帖子：11 <br>-->

																<span class="icon-diamond text-danger" title="精华数"></span><span class="text-bold text-danger"> 3</span>
								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-678772.htm">wangrin</a>
									</span>
									
									<span class="date text-grey m-l-sm">10小时前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491330" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491330" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">9</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								可以可以，最近正缺这方面的资料																								
								
							</div>
						</td>
					</tr>
																																			
					<tr class="post" pid="1491334" id="point_1491334">
						<td class="vtop td-avatar" style="width: 46px;">
							<a href="http://bbs.pediy.com/user-750125.htm" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/avatar.png">
							</a>
							<div>
								<span class="group group-101 m-r-xs"></span>
							</div>
							<div class="text-grey text-tiny" style="text-align: center; margin-top: -4px; ">
								
								<!--注册：2017-4 <br>
								帖子：19 <br>-->

								
								<!--<span class="hidden-md-down" title=""></span>
								-->
							</div>
							
							
						</td>
						<td class="p-x-0">
							<dl class="row small">
								<dt>
									
									
									<span class="username text-bold">
										<a href="http://bbs.pediy.com/user-750125.htm">AperOdry</a>
									</span>
									
									<span class="date text-grey m-l-sm">9小时前</span>
									
								</dt>
								<dd class="text-right text-grey ">
																											
																		<a href="javascript:void(0)" tid="220405" pid="1491334" class="text-grey post_reply m-r-1"><i class="icon-reply"></i> 引用</a>
																		
									

																	
									
									
									<a id="exampleModalLabel report" data-toggle="modal" data-target="#report" data-tid="220405" data-pid="1491334" data-confirm-text="举报帖子" href="javascript:void(0);" class="text-grey post_report _confirm m-r-1"><i class="icon-warning"></i> 举报</a>
									
									

																		<span class="floor">10</span> 楼																		
								</dd>
							</dl>
							<div class="message m-t-xs break-all">
																								谢谢&nbsp; &nbsp; 我想我对于x64初窥门径了																								
								
							</div>
						</td>
					</tr>
								
				
					
										<tr class="post" id="point_undefined">
						<td class="td-avatar" aria-hidden="true">
							<a href="http://bbs.pediy.com/user-412913.htm" aria-hidden="true" tabindex="-1">
								<img class="avatar" src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/463708.png">
							</a>
						</td>
						<td class="p-l-0">
							<form action="http://bbs.pediy.com/post-create-220405-1.htm" method="post" id="quick_reply_form">	
								<input type="hidden" name="doctype" value="1">
								<input type="hidden" name="return_html" value="1">
								<input type="hidden" name="quotepid" value="0">
								<dl class="row small text-muted">
									<dt class="username">MallocFree</dt>
									<dd class="text-right text-grey"><span class="floor">11</span>楼</dd>
								</dl>
								<div class="message m-t-xs">
									<fieldset class="form-group m-b-0">
										<textarea class="form-control" placeholder="内容" name="message" id="message"></textarea>
									</fieldset>
								</div>
								<div class="text-muted  m-t-sm small face_open">
									<dl class="row">
										<dt>
											
											<button type="submit" class="btn btn-sm btn-primary" id="submit" data-loading-text="正在提交...">　回帖　</button>
											
											<span class="emotion m-l-1">表情</span>
											<span class="m-l-1"><a href="http://bbs.pediy.com/thread-216598.htm" target="_bank" class="text-danger">回帖送Kx币</a></span>
										</dt>
										<dd class="text-right vtop">
											
											<a class="icon-mail-forward text-muted" href="http://bbs.pediy.com/post-create-220405.htm" id="advanced_reply"> 高级回复</a>
											
										</dd>
									</dl>
								</div>
							<input type="hidden" name="3xf8gotid0ufnbe9" value="3xf8gotid0ufnbe9"><input type="hidden" name="__anti_xss__" value="1502841785_6bee1b7c8af19356f40b4c94064d1a63"></form>
						</td>
					</tr>
									</tbody>
			</table>
		</div>
		
		
				
		
		
				
				
		<a role="button" class="btn btn-secondary btn-block xn-back m-y-1 m-x-auto" style="max-width: 50%;" href="javascript:history.back();">返回</a>
		
		<br>
		<br>
		
		
			<br>


			

			<hr>
			<dl class="row text-muted text-small m-y-1" id="web_base_company_information">
				<dt class="col-xs-12 col-sm-12 col-md-6">
					  ©2000-2017 看雪学院 | Based on <a href="http://bbs.xiuno.com/" target="_blank" class="text-muted text-bold">Xiuno BBS</a> | 知道创宇带宽支持 | 微信公众号：ikanxue
				</dt>
				<dd class="col-xs-12 col-sm-12 col-md-6" style="text-align: right;">
					Time: <b>0.015</b>, SQL: <b>11</b>
					/ 京ICP备10040895号-17 
				</dd>
			</dl>
		</div>
	</div>
<div>





<!--
</div>
-->





<!--[if lt IE 9]>
<script>window.location = 'browser.htm';</script>
<![endif]-->


<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bbs.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/jquery-3.1.0.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/tether.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bootstrap.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bootstrap-plugin.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/async.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/xiuno.js"></script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/form.js"></script>



<script>
var debug = DEBUG = 0;
var url_rewrite_on = 1;
var forumarr = {
    "20": "『悬赏问答』",
    "45": "『茶余饭后』",
    "47": "『招聘专区』",
    "52": "OllyDbg插件收集区",
    "69": "『经典问答』",
    "122": "CTF2017提交区(隐藏版块)",
    "102": "『科锐培训』",
    "141": "CrackMe存档区",
    "151": "『WEB安全』",
    "2": "『论坛版务』",
    "4": "『软件逆向』",
    "117": "『资料导航』",
    "53": "IDA Pro插件收集区",
    "76": "1)珠海金山2007逆向分析挑战",
    "99": "《加密与解密(第三版)》",
    "169": "『15PB培训』",
    "125": "奇虎360软件安全大赛答案提交区",
    "152": "你问我答",
    "150": "『二进制漏洞』",
    "128": "『智能设备』",
    "21": "《软件加密技术内幕》",
    "68": "2)PEDIY Crackme竞",
    "41": "『编程技术』",
    "79": "智能设备",
    "78": "『申请提交区』",
    "95": "《0day:软件漏洞分析技术》",
    "137": "『职业生涯』",
    "160": "『麦洛克菲培训』",
    "161": "『Android安全』",
    "162": "『企业SRC』",
    "166": "『iOS安全』",
    "88": "『加壳脱壳』",
    "91": "3)看雪论坛2008 Explo",
    "158": "移动平台",
    "3": "桌面平台",
    "120": "4)腾讯公司2008软件安全竞赛",
    "97": "《Windows编程循序渐进》",
    "132": "『密码算法』",
    "123": "《微软.NET程序的加密与解密》",
    "127": "5)奇虎360软件安全比赛",
    "37": "『CrackMe』",
    "140": "6)PEDIY Crackme竞",
    "108": "渗透技术",
    "32": "『外文翻译』",
    "64": "『会员专区』",
    "65": "『图书项目』",
    "163": "《C++反汇编与逆向分析技术揭秘",
    "10": "『资源下载』",
    "116": "看雪CTF",
    "155": "8)腾讯公司2010软件安全竞赛",
    "168": "《Android软件安全与逆向分",
    "136": "职场风云",
    "157": "9)2011 Exploit M",
    "154": "论坛生活",
    "121": "11）移动安全挑战赛（MSC）",
    "129": "12）2015第2届移动安全挑战",
    "170": "看雪产品",
    "1": "站务管理"
};
var fid = 32;
var uid = 463708;
var gid = 101;
$('[data-toggle="tooltip"]').tooltip();
$('#search_form > input').on('click', function() {return false; });
</script>
<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/bbs(1).js"></script>
<script>
// 版主管理：精华
$('.mod-button button.digest').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var radios = xn.form_radio('digest', {"0": "取消精华", "1": "关注","2": "优秀", "3": "精华"});
	$.confirm("设置主题为精华", function() {
		var tids = xn.implode('_', modtid);
		var digest = $('input[name="digest"]').checked();
		var postdata = {digest: digest};
		$.xpost(xn.url('mod-digest-'+tids), postdata, function(code, message) {
			if(code != 0) return $.alert(message);
			$.alert(message).delay(1000).location('');
		});
	}, {'body': '<p>'+"精华等级"+'：'+radios+'</p>'});
})
</script><script>
function xn_read_unread(tids, tid) {
	
	// 当前时间
	var time = xn.time();
	
	// 多长时间内的主题为最新主题
	var time_range = 86400 * 3;
	
	// 三天内的 tids
	var recent_tids = $.pdata('recent_tids') || {};
	
	// 已读的 tids
	var view_tids = $.pdata('view_tids') || {};
	// 提取列表页的 tid
	function fetch_recent_tids(tids) {
		var changed = false;
		$.each(tids, function(tid, last_date) {
			if(time - last_date < time_range) {
				recent_tids[tid] = last_date;
				changed = true;
			}
		});
		if(changed) $.pdata('recent_tids', recent_tids);
	}
	
	// 清理最近的 tid
	function gc_recent_tids() {
		var changed = false;
		$.each(recent_tids, function(tid, last_date) {
			if(time - last_date > time_range) {
				delete recent_tids[tid];
				changed = true;
			}
		});
		if(changed) $.pdata('recent_tids', recent_tids);
	}
	
	function gc_view_tids() {
		var changed = false;
		$.each(view_tids, function(tid, last_date) {
			if(!recent_tids[tid]) {
				delete view_tids[tid];
				changed = true;
			}
		});
		if(changed) $.pdata('view_tids', view_tids);
	}
	
	function save_view_tid(tid) {
		if(!recent_tids[tid]) return;
		view_tids[tid] = time;
		$.pdata('view_tids', view_tids);
	}
	
	if(tids) {
		fetch_recent_tids(tids);
		gc_recent_tids();
		//gc_view_tids();
	}
	if(tid) save_view_tid(tid);
	
	// 三天内的主题标记为已读
	
	// 遍历主题列表，标记最近的，并且未读的为加粗

	$('tr.thread').each(function() {
		var jthis = $(this);
		var tid = jthis.attr('tid');
		if(recent_tids[tid] && recent_tids[tid] > xn.intval(view_tids[tid])) {
			//jthis.find('div.subject').addClass('text-bold');
			jthis.find('div.subject').append('<span class="icon-new"></span>');
			jthis.find('span.icon-post-grey').removeClass('icon-post-grey').addClass('icon-post-blue');
		}
	});
}

</script>

<script type="text/javascript">
$(function() {
	$.require('http://www.google-analytics.com/ga.js', function() {
		try {
			var pageTracker = _gat._getTracker("UA-9784446-1");
			pageTracker._trackPageview();
		} catch(err) {}
	});
});
</script>



<script>

var forumlist = [
    {
        "fid": "20",
        "fup": "152",
        "name": "『悬赏问答』",
        "rank": "29"
    },
    {
        "fid": "29",
        "fup": "2",
        "name": "『论坛管理团队』",
        "rank": "29"
    },
    {
        "fid": "45",
        "fup": "154",
        "name": "『茶余饭后』",
        "rank": "29"
    },
    {
        "fid": "47",
        "fup": "136",
        "name": "『招聘专区』",
        "rank": "29"
    },
    {
        "fid": "52",
        "fup": "10",
        "name": "OllyDbg插件收集区",
        "rank": "29"
    },
    {
        "fid": "69",
        "fup": "20",
        "name": "『经典问答』",
        "rank": "29"
    },
    {
        "fid": "122",
        "fup": "37",
        "name": "CTF2017提交区(隐藏版块)",
        "rank": "29"
    },
    {
        "fid": "102",
        "fup": "137",
        "name": "『科锐培训』",
        "rank": "29"
    },
    {
        "fid": "141",
        "fup": "140",
        "name": "CrackMe存档区",
        "rank": "29"
    },
    {
        "fid": "151",
        "fup": "108",
        "name": "『WEB安全』",
        "rank": "29"
    },
    {
        "fid": "2",
        "fup": "1",
        "name": "『论坛版务』",
        "rank": "28"
    },
    {
        "fid": "4",
        "fup": "3",
        "name": "『软件逆向』",
        "rank": "28"
    },
    {
        "fid": "117",
        "fup": "152",
        "name": "『资料导航』",
        "rank": "28"
    },
    {
        "fid": "53",
        "fup": "10",
        "name": "IDA Pro插件收集区",
        "rank": "28"
    },
    {
        "fid": "76",
        "fup": "37",
        "name": "1)珠海金山2007逆向分析挑战",
        "rank": "28"
    },
    {
        "fid": "99",
        "fup": "65",
        "name": "《加密与解密(第三版)》",
        "rank": "28"
    },
    {
        "fid": "169",
        "fup": "137",
        "name": "『15PB培训』",
        "rank": "28"
    },
    {
        "fid": "125",
        "fup": "127",
        "name": "奇虎360软件安全大赛答案提交区",
        "rank": "28"
    },
    {
        "fid": "152",
        "fup": "0",
        "name": "你问我答",
        "rank": "28"
    },
    {
        "fid": "150",
        "fup": "108",
        "name": "『二进制漏洞』",
        "rank": "28"
    },
    {
        "fid": "128",
        "fup": "79",
        "name": "『智能设备』",
        "rank": "27"
    },
    {
        "fid": "21",
        "fup": "65",
        "name": "《软件加密技术内幕》",
        "rank": "27"
    },
    {
        "fid": "68",
        "fup": "37",
        "name": "2)PEDIY Crackme竞",
        "rank": "27"
    },
    {
        "fid": "41",
        "fup": "3",
        "name": "『编程技术』",
        "rank": "27"
    },
    {
        "fid": "79",
        "fup": "0",
        "name": "智能设备",
        "rank": "27"
    },
    {
        "fid": "78",
        "fup": "2",
        "name": "『申请提交区』",
        "rank": "27"
    },
    {
        "fid": "95",
        "fup": "65",
        "name": "《0day:软件漏洞分析技术》",
        "rank": "27"
    },
    {
        "fid": "137",
        "fup": "136",
        "name": "『职业生涯』",
        "rank": "27"
    },
    {
        "fid": "160",
        "fup": "137",
        "name": "『麦洛克菲培训』",
        "rank": "27"
    },
    {
        "fid": "161",
        "fup": "158",
        "name": "『Android安全』",
        "rank": "27"
    },
    {
        "fid": "162",
        "fup": "170",
        "name": "『企业SRC』",
        "rank": "27"
    },
    {
        "fid": "166",
        "fup": "158",
        "name": "『iOS安全』",
        "rank": "27"
    },
    {
        "fid": "88",
        "fup": "3",
        "name": "『加壳脱壳』",
        "rank": "26"
    },
    {
        "fid": "91",
        "fup": "37",
        "name": "3)看雪论坛2008 Explo",
        "rank": "26"
    },
    {
        "fid": "158",
        "fup": "0",
        "name": "移动平台",
        "rank": "26"
    },
    {
        "fid": "3",
        "fup": "0",
        "name": "桌面平台",
        "rank": "25"
    },
    {
        "fid": "120",
        "fup": "37",
        "name": "4)腾讯公司2008软件安全竞赛",
        "rank": "25"
    },
    {
        "fid": "57",
        "fup": "2",
        "name": "『回收站』",
        "rank": "25"
    },
    {
        "fid": "97",
        "fup": "65",
        "name": "《Windows编程循序渐进》",
        "rank": "25"
    },
    {
        "fid": "132",
        "fup": "3",
        "name": "『密码算法』",
        "rank": "24"
    },
    {
        "fid": "123",
        "fup": "65",
        "name": "《微软.NET程序的加密与解密》",
        "rank": "24"
    },
    {
        "fid": "127",
        "fup": "37",
        "name": "5)奇虎360软件安全比赛",
        "rank": "24"
    },
    {
        "fid": "37",
        "fup": "116",
        "name": "『CrackMe』",
        "rank": "23"
    },
    {
        "fid": "140",
        "fup": "37",
        "name": "6)PEDIY Crackme竞",
        "rank": "23"
    },
    {
        "fid": "108",
        "fup": "0",
        "name": "渗透技术",
        "rank": "22"
    },
    {
        "fid": "32",
        "fup": "136",
        "name": "『外文翻译』",
        "rank": "22"
    },
    {
        "fid": "64",
        "fup": "154",
        "name": "『会员专区』",
        "rank": "22"
    },
    {
        "fid": "65",
        "fup": "170",
        "name": "『图书项目』",
        "rank": "22"
    },
    {
        "fid": "163",
        "fup": "65",
        "name": "《C++反汇编与逆向分析技术揭秘",
        "rank": "22"
    },
    {
        "fid": "10",
        "fup": "3",
        "name": "『资源下载』",
        "rank": "21"
    },
    {
        "fid": "116",
        "fup": "0",
        "name": "看雪CTF",
        "rank": "21"
    },
    {
        "fid": "155",
        "fup": "37",
        "name": "8)腾讯公司2010软件安全竞赛",
        "rank": "21"
    },
    {
        "fid": "168",
        "fup": "65",
        "name": "《Android软件安全与逆向分",
        "rank": "21"
    },
    {
        "fid": "136",
        "fup": "0",
        "name": "职场风云",
        "rank": "20"
    },
    {
        "fid": "157",
        "fup": "37",
        "name": "9)2011 Exploit M",
        "rank": "20"
    },
    {
        "fid": "154",
        "fup": "0",
        "name": "论坛生活",
        "rank": "18"
    },
    {
        "fid": "121",
        "fup": "37",
        "name": "11）移动安全挑战赛（MSC）",
        "rank": "18"
    },
    {
        "fid": "129",
        "fup": "37",
        "name": "12）2015第2届移动安全挑战",
        "rank": "17"
    },
    {
        "fid": "170",
        "fup": "0",
        "name": "看雪产品",
        "rank": "12"
    },
    {
        "fid": "1",
        "fup": "0",
        "name": "站务管理",
        "rank": "0"
    }
];

// 三级版块
function forum_tree(forumlist, template) {
	var template = template || '<option value="{fid}">{tab}{name}</option>'+"\r\n";
	var s = '';
	var forumlist1 = forumlist.filter(function(v) {return v.fup == 0});
	for(var i1=0; i1<forumlist1.length; i1++) {
		var v1 = forumlist1[i1];
		s += '►'+xn.template(template, {fid: v1.fid, name: v1.name, tab: "　"});
		var forumlist2 = forumlist.filter(function(v2) {return v2.fup == v1.fid});
		for(var i2=0; i2<forumlist2.length; i2++) {
			var v2 = forumlist2[i2];
			s += xn.template(template, {fid: v2.fid, name: v2.name, tab: "　　"});
			var forumlist3 = forumlist.filter(function(v3) {return v3.fup == v2.fid});
			for(var i3=0; i3<forumlist3.length; i3++) {
				var v3 = forumlist3[i3];
				s += xn.template(template, {fid: v3.fid, name: v3.name, tab: "　　　　"});
			}

		}
	}
	return s;
}


// 版主管理：移动 / moderator : move
$('.mod-button button.move').off('click').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var select = '<select name="fid">'+forum_tree(forumlist)+'</select>';
	$.confirm(lang.move_forum, function() {
		var tids = xn.implode('_', modtid);
		var newfid = $('select[name="fid"]').val();
		$.xpost(xn.url('mod-move-'+tids+'-'+newfid), function(code, message) {
			if(code != 0) return $.alert(message);
			$.alert(message).delay(1000).location('');
		});
	}, {'body': '<p>'+lang.choose_move_forum+'：'+select+'</p>'});
})

</script><script>

// 版主管理：审核
$('.mod-button button.audit').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var radios = xn.form_radio('audit', {"1": "审核通过", "2": "审核不通过"});
	$.confirm('审核主题', function() {
		var tids = xn.implode('_', modtid);
		var audit = $('input[name="audit"]').checked();
		var postdata = {audit: audit};
		$.xpost(xn.url('mod-audit-'+tids), postdata, function(code, message) {
			if(code != 0) return $.alert(message);
			$.alert(message).delay(1000).location('');
		});
	}, {'body': '<p>'+'审核选项'+'：'+radios+'</p>'});
})

</script><script>
$('form').append('<input type="hidden" name="3xf8gotid0ufnbe9" value="3xf8gotid0ufnbe9" />');

$('form').append('<input type="hidden" name="__anti_xss__" value="1502841785_6bee1b7c8af19356f40b4c94064d1a63" />');
$.cookie('__anti_xss__', '1502841785_6bee1b7c8af19356f40b4c94064d1a63');

// 重新定义 $.xpost()，追加 postdata
$.xpost_old = $.xpost;
$.xpost = function(url, postdata, callback, progress_callback) {
	if(xn.is_object(postdata)) {
		postdata['__anti_xss__'] = '1502841785_6bee1b7c8af19356f40b4c94064d1a63';
	} else if(xn.is_string(postdata)) {
		postdata += '&__anti_xss__=1502841785_6bee1b7c8af19356f40b4c94064d1a63';
	} else if(xn.is_function(postdata)) {
		callback = postdata;
		postdata = {__anti_xss__: '1502841785_6bee1b7c8af19356f40b4c94064d1a63'};
	}
	return $.xpost_old(url, postdata, callback, progress_callback);
};

</script>
<script>

$(function() {
	// 版主管理：删除 / moderator : delete
	$('.mod-button button.delete').off('click').on('click', function() {
		var modtid = $('input[name="modtid"]').checked();
		if(modtid.length == 0) return $.alert(lang.please_choose_thread);
		var radios = '';
				//var htmladd = '<br><br><label class="text-small"><input type="checkbox" name="logic" value="0" /> 物理删除</label>';
		//htmladd += '<br><label class="text-small"><input type="checkbox" name="logic" value="0" /> 恢复删除</label>';
		$.confirm(xn.lang('confirm_delete_thread', {n:modtid.length}) + '<br><br>'+radios, function() {
			var tids = xn.implode('_', modtid);
			var type = $('input[name="type"]').checked();
			$.xpost(xn.url('mod-delete-'+tids), {type: type}, function(code, message) {
				if(code != 0) return $.alert(message);
				$.alert(message).delay(1000).location('');
			});
		});
	})

	// 恢复逻辑删除的帖子
	$('body').on('click', '.post_recover', function() {
		var jthis = $(this);
		var href = jthis.data('href');
		var isfirst = jthis.attr('isfirst');
		if(window.confirm('确定恢复删除的帖子？')) {
			$.xpost(href, function(code, message) {
				var isfirst = jthis.attr('isfirst');
				if(code == 0) {
					if(isfirst == '1') {
						$.location('forum-32.htm');
					} else {
						window.location.reload();
					}
				} else {
					$.alert(message);
				}
			});
		}
		return false;
	});

})

</script>

<script>
$('#nav_pc li[fid="32"]').tab('show');
$('#frame_right').focus();

// 随机雪花
/*
var jframe_left = $('#frame_left');
jframe_left.css('position', 'relative');
jframe_left.now = Date.now();
var jsnow = $('<span style="background: url(plugin/kanxue/img/snow.png); background-size: cover; width: 32px; height: 32px; z-index:1;"></span>').appendTo('body').hide();
var jframe_left_height = jframe_left.height();
jframe_left.on('mousemove', function(e) {
	// 随机生成雪花，飘落 css3
	var t = Date.now();
	if (t - jframe_left.now < 500) return;
	jframe_left.now = t;
	var jclone = jsnow.clone().appendTo(jframe_left).show();
	var rand = xn.random(5, 40);
	jclone.css('position', 'absolute').css('left', e.clientX - 60).css('bottom', jframe_left_height - e.clientY).width(rand).height(rand).addClass('snow');
	setTimeout(function() {
		jclone.remove();
	}, 20000);
});
*/

var frame_left = $("#frame_left");	
var frame_left_save_the_status = 0;
var frame_left_hide_button = $(".frame_left_right_hide_button");
var frame_left_show_button = $(".frame_left_left_show_button");
//(隐藏按键Right_hide_button，显示按键Left_show_button，HiddenDOM隐藏DOM)
frame_left_hide_button.click(function() {
	frame_left.removeClass("frame_left_show_animation frame_left_show_initial_state");
	frame_left.addClass("frame_left_hide_animation");
	var t = setTimeout(function(){frame_left_show_button.css("display","block");},100);
	$(".forumlist").css("display","none");		
	frame_left_save_the_status = 1;
	$.cookie('frame_left_status',frame_left_save_the_status);	
});
frame_left_show_button.click(function() {
	frame_left_show_button.css("display", "none");
	frame_left_hide_button.css("display", "block");
	frame_left.removeClass("frame_left_hide_initial_state frame_left_hide_animation");
	frame_left.addClass("frame_left_show_animation");
	var t = setTimeout(function(){$(".forumlist").css("display","block");},100);
	frame_left_save_the_status = 0;
	$.cookie('frame_left_status',frame_left_save_the_status);	
});
var frame_left_left_state_aid_value  = $.cookie('frame_left_status');
if(frame_left_left_state_aid_value == 0){
	frame_left_show_button.css("display", "none");
	frame_left_hide_button.css("display", "block");
	frame_left.removeClass("frame_left_hide_animation");
	frame_left.addClass("frame_left_show_initial_state");	
}else if(frame_left_left_state_aid_value == 1){
	frame_left_show_button.css("display","block");
	frame_left_hide_button.css("display", "none");
	frame_left.removeClass("frame_left_show_animation");
	frame_left.addClass("frame_left_hide_initial_state");		
};

</script>
<script>
    $(function(){
        var pm_number = "//www.kanxue.com/pm-new.htm";
        $.xget(pm_number,function(code,message){
            if(code == 0){
                var newpms = parseInt(message.newpms );
                
                var system_pms = parseInt(message.system_pms);
                
                var pm_total = newpms + system_pms;
                if(pm_total != 0){
                    
					pm_total = pm_total>99 ? "99+" : pm_total;
                    $(".pm_total").html(pm_total);
                    $(".pm_total").css({
                        "display": "inline-block",
                        "padding": "0px 7px",
                        "font-size": "12px",
                        "font-weight": "bold",
                        "line-height": "14px",
                        "color": "white",
                        "background-color": "#f57e42",
                        "border-radius": "9px",
                        "text-indent": "0px"
                    });
					if(system_pms>0 && newpms == 0) {
						var href = "//www.kanxue.com/pm-system_read-1.htm";
						$(".pm_total_a").attr("href",href);
                    }    
                }else{
                    // $(".pm_total_a").css("display","none");
                }
                
            }else{
                // $(".pm_total_a").css("display","none");

                $(".pm_total").css({
                        "display": "inline-block",
                        "padding": "0px 3px",
                        "font-size": "12px",
                        "font-weight": "bold",
                        "line-height": "14px",
                        "color": "white",
                        "background-color": "#f57e42",
                        "border-radius": "9px",
                        "text-indent": "0px"
                    });
                
            }
        })
    });
// 下拉菜单禁止body滚动
$(document).ready(function(){
	 
	$('.dropdown-toggle').attr("data-sign","0");
	$('.dropdown-toggle').on("click",function(){
		var sign = $('.dropdown-toggle').attr("data-sign");
		if(sign == 0){
			 
			$("body").css({"position":"fixed","overflow":"hidden"});
			$('.dropdown-toggle').attr("data-sign","1");
		} else {
			 
			$("body").css({"position":"static","overflow":"auto"});
			$('.dropdown-toggle').attr("data-sign","0");
		}


	})
})








if (window.innerWidth < 768) {
	$(document).ready(function(){
		$(".threadlist .thread .td-avatar a").attr("href","javascript:void(0)");
	});
}
  
</script>	
	



<div class="modal fade report" id="report" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">举报此帖</h4>
                        </div>
                        <form id="form_report" action="http://bbs.pediy.com/post-report.htm" method="post">
                                <div class="modal-body">
                                        <div class="form-group">
                                                <input id="tid" name="tid" value="0" type="hidden">
                                                <input id="pid" name="pid" value="0" type="hidden">
                                                <textarea class="form-control" id="brief" name="brief" rows="6" placeholder="请填写内容，注意: 请确认您所举报此帖的内容涉及到语言挑衅和违犯论坛版规的内容， 版主将收到举报后审核该帖！"></textarea>
                                        </div>
                                </div>
                                <div class="modal-footer">
                                        <button id="report_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">发送报告</button>
                                </div>
                        </form>
                </div>
        </div>
</div>

<div class="modal fade appeal" id="appeal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">求助问答申诉</h4>
                        </div>
                        <form id="form_appeal" action="http://bbs.pediy.com/post-appeal.htm" method="post">
	                        <div class="modal-body">
	                                <div class="form-group">
	                                	<input id="pid" name="pid" value="0" type="hidden">
	                                        <textarea class="form-control" id="brief" name="brief" rows="6" placeholder="请填写内容，注意: 请写明申诉的原因"></textarea>
	                                </div>
	                        </div>
	                        <div class="modal-footer">
	                                <button id="appeal_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">申请提交</button>
	                        </div>
	                </form>
                </div>
        </div>
</div>

<script src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/face.js"></script>

<script>
    var jform = $('#quick_reply_form');
    var jsubmit = $('#submit');
    jform.on('submit', function() {
        jform.reset();
        jsubmit.button('loading');
        var postdata = jform.serialize();
        $.xpost(jform.attr('action'), postdata, function(code, message) {
            if (code == 0) {
                var s = '<table>' + message + '</table>';
                var jtr = $(s).find('tr');
                jtr.insertBefore($('table.postlist tr').last());
                jsubmit.button('reset');
                $('#message').val('');

                // 楼层 +1
                var jfloor = jform.find('.floor');
                jfloor.html(xn.intval(jfloor.html()) + 1);

                // 回复数 +1
                var jposts = $('.posts');
                jposts.html(xn.intval(jposts.html()) + 1);

            } else if (code < 0) {
                $.alert(message);
                jsubmit.button('reset');
            } else {
                jform.find('[name="' + code + '"]').alert(message).focus();
                jsubmit.button('reset');
            }
        });
        return false;
    });


    //收藏功能
    var jfavorite = $('#favorite');
    var jlikes = $('#likes');
   
    jfavorite.on('click', function() {
    	var likenum = jlikes.text();
    	likenum_plus = parseInt(likenum) + 1;
    	likenum_sub = parseInt(likenum) - 1;
    	if(likenum_sub < 0) likenum_sub = 0;
        $.xpost('thread-favorite-220405.htm', function(code, message) {
            if(code == 0) {
                var s = '<a href="javascript:void(0)" title="取消收藏"><i class="icon-star"></i>&nbsp;已收藏</a>';
                jfavorite.html(s);
                jlikes.text(likenum_plus);

            }else if(code == 1) {
            	var s = '<a href="javascript:void(0)" title="点我收藏"><i class="icon-star-o"></i>&nbsp;收藏</a>';
                jfavorite.html(s);
                jlikes.text(likenum_sub);
            } else {
                $.alert(message);
            }
        });
        return false;
    });


    // 缩放图片，适应屏幕大小。
    function resize_image() {
        var jmessagelist = $('div.message');
        var first_width = jmessagelist.width(); // 815 : 746; //  734 746
        jmessagelist.each(function() {
            var jdiv = $(this);
            var maxwidth = jdiv.attr('isfirst') ? first_width : first_width - 79; //  734 746
            var jmessage_width = Math.min(jdiv.width(), maxwidth);
            jdiv.find('img, embed, iframe').each(function() {
                var jimg = $(this);
                //if(jimg.width() < 500) return;
                var img_width = this.org_width;
                var img_height = this.org_height;
                if (!img_width) {
                    var img_width = jimg.width();
                    var img_height = jimg.height();
                    this.org_width = img_width;
                    this.org_height = img_height;
                }
                //var percent = xn.min(100, xn.ceil((img_width / jmessage_width) * 100));
                if (img_width > jmessage_width) {
                    if (this.tagName == 'IMG') {
                        jimg.width(jmessage_width);
                        jimg.css('height', 'auto');
                    } else {
                        jimg.width(jmessage_width);
                        var height = (img_height / img_width) * jimg.width();
                        jimg.height(height);
                    }
                }

            });
        });
    }
    $(function() {

        resize_image();
        $(window).on('resize', resize_image);
     	//---------by wang start------------------------//
    	//取出tr的pid，赋值给tr使name为point_pid
        $(".post").each(function() {
        	var cpid = $(this).attr("pid");
        	$(this).attr("id","point_"+ cpid);
        });
    	var url = window.location.toString();
    	if(url.indexOf("#") != -1){
    		var id = url.split("#")[1];
			if(id) {
			var t = $("#"+id).offset() ? $("#"+id).offset().top : 0;
			//$("#frame_right").scrollTop(t);
			$("#frame_right").animate({scrollTop:t},800)
			}
    	}
		
		//------------by wang end----------------------------//

	});
    	
    // 输入框自动伸缩
    var jmessage = $('#message');
    jmessage.on('focus', function() {
        if (jmessage.t) {
            clearTimeout(jmessage.t);
            jmessage.t = null;
        }
        jmessage.css('height', '6rem');
    });
    jmessage.on('blur', function() {
        jmessage.t = setTimeout(function() {
            jmessage.css('height', '2.5rem');
        }, 1000);
    });

    $('#nav_pc li[fid="32"]').tab('show');
    $('#nav_mobile li[fid="32"]').tab('show');

     $(function(){
		$('.emotion').qqFace({
			id : 'facebox',
			assign:'message',
			path:'view/img/face/'
		});
	});
</script>

<script>
var jpay_form = $('#pay_kx');
var jkxpay = $('.kx-pay');
var rid = 0;
var check_handle = null;

function topay(){
    clearInterval(check_handle);
    check_handle = null;
    var valtype = $("input[name='reward_type']:checked").val();
    var rmbstype = $("input[name='reward_rmbs']:checked").val();
    if(!valtype) { alert('请您选择一个支付方式!'); return false; }
    if(rmbstype < 1){
        alert("好扣哦，打赏金额不能少于1元");
        return false;
    }else if(valtype == 1){
        if(_is_weixin) {
            $.alert('请用其它浏览器打开再用赞赏功能!');
            return false;
        }
        window.Popup = window.open('about:blank', '_blank','width='+window.screen.width+',height='+window.screen.height+', ...');
        var ptdata = jpay_form.serialize();
        jkxpay.button('loading');
        $.xpost('reward_pay-charge.htm', ptdata, function(code, message) {
            if(code == 0) {
                Popup.blur();
                Popup.opener.focus();
                Popup.location = 'reward_pay-reward_alipay-'+ message +'.htm';
                jkxpay.button('reset');
                $('.reward').modal('hide');
                check_setInterval(message);
            } else if(code < 0) {
                Popup.close();
                alert(message);
                jkxpay.button('reset');
            } else {
                Popup.close();
                alert(message);
                jkxpay.button('reset');
            }
        });
        return false;
    }else if(valtype == 2){
        var postdata = jpay_form.serialize();
        jkxpay.button('loading');
        $.xpost('reward_pay-reward_remainder.htm', postdata, function(code, message) {
            if(code == 0) {
                $.alert(message);
                jkxpay.button('reset');
                $('.reward').modal('hide');
                window.location.reload();
            } else if(code < 0) {
               $.alert(message);
                jkxpay.button('reset');
            } else {
                $.alert(message);
                jkxpay.button('reset');
            }
        });
        return false;
    }else{
        $('.reward').modal('hide');
        return false;
    }
}

function check_status(rid) {
  $.xpost('reward_pay-check.htm', {checkid: rid}, function(code, message) {
    if(code == 0) {
      Popup.close();
      $.alert('恭喜您，赞赏成功！');
      setTimeout(function() {
                 window.location.reload();
      }, 3000);
      // if(check_handle) {
        clearInterval(check_handle);
        check_handle = null;
      // }
    } else {
      return false;
    }
  });
}

function check_setInterval(rid) {
  check_handle = setInterval(function() {
    check_status(rid);
  }, 3000);
}

window._is_weixin = function() {
  var _ua = window.navigator.userAgent.toLowerCase();
  if (_ua.match(/MicroMessenger/i) == 'micromessenger') {
      return true;
  } else {
      return false;
  }
}()

</script><script>
var jform_appeal = $('#form_appeal');
var appeal_submit = $('#appeal_submit');

appeal_submit.on('click', function() {
    jform_appeal.reset();
    appeal_submit.button('loading');
    var postdata = jform_appeal.serialize();
    
    $.xpost(jform_appeal.attr('action'), postdata, function(code, message) {
        if(code == 0) {
       	$.alert(message);
       	appeal_submit.button('reset');
       	setTimeout(function(){window.location.reload();
            }, 2000);
        } else {
    	$.alert(message);
    	appeal_submit.button('reset');
        }
    });
    return false;
});

 $('#appeal').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget)
	var pid = button.data('pid');
	var modal = $(this);
	modal.find('.modal-body #pid').val(pid);

})
</script><script>

var jform_report = $('#form_report');
var report_submit = $('#report_submit');

report_submit.on('click', function() {
    jform_report.reset();
    report_submit.button('loading');
    var postdata = jform_report.serialize();
    
    $.xpost(jform_report.attr('action'), postdata, function(code, message) {
        if(code == 0) {
       	$.alert(message);
       	report_submit.button('reset');
       	setTimeout(function(){window.location.reload();
            }, 1000);
        } else {
    	$.alert(message);
    	report_submit.button('reset');
        }
    });
    return false;
});

$('#report').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget)
    var tid = button.data('tid');
    var pid = button.data('pid');
    var modal = $(this);

    modal.find('.modal-body #tid').val(tid);
    modal.find('.modal-body #pid').val(pid);
})

</script><!--游客下载附件关注微信公众号-->
<div class="modal fade download_code" id="download_code" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                        <div class="modal-header">
	                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                                <span aria-hidden="true">×</span>
	                        </button>
	                        <h5 class="modal-title" id="exampleModalLabel">游客下载提示</h5>
                        </div>
                        <form id="form_download" action="http://bbs.pediy.com/thread-220405.htm" method="post" target="_blank">
                                <div class="modal-body text-center">
                                    <input id="aid" name="aid" value="0" type="hidden">
                                    <dl class="row">
                                    	<dd class="text-left" style="width:50%">
                                        	<div style="font-size:14px">
                                        		<div>1.请先关注公众号。</div>
                                        		<div>2.点击菜单"更多"。</div>
                                        		<div>3.选择获取下载码。</div>
                                        	</div>
                                    	</dd>
                                    	<dt><img src="./[翻译]多种DLL注入技术原理介绍-『外文翻译』-看雪安全论坛_files/wxgz.jpg" width="80%"></dt>
                                    </dl>
                                    <fieldset class="form-group">
                						<input class="form-control" type="text" id="download_code" name="download_code" placeholder="请输入下载码" value="">
                					</fieldset>
                                </div>
                                <div class="modal-footer">
                                        <button id="download_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">下载</button>
                                </div>
                        </form>
                </div>
        </div>
</div>

<script>

var jform_download = $('#form_download');
var jdownload_submit = $('#download_submit');

jdownload_submit.on('click', function() {
    jform_download.reset();
    jdownload_submit.button('loading');
    var postdata = jform_download.serialize();

    var aid2 = jform_download.find('.modal-body #aid').val();
    
    $.xpost(jform_download.attr('action'), postdata, function(code, message) {
        if(code == 0) {
	       	jdownload_submit.button('下载中...');
	       	var href = "attach-download-"+aid2+"-"+message+".htm";
		window.location = href;
		setTimeout(function() {
                    jdownload_submit.button('reset');
                    jform_download.find('.modal-body #download_code').val('');
                }, 1500);
		
        } else {
	    	$.alert(message);
	    	jdownload_submit.button('reset');
        }
    });
    return false;
});

$('#download_code').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget)
    var aid = button.data('aid');
    var modal = $(this);
    var down_action="attach-download_code-"+aid+".htm";

    modal.find('.modal-body #aid').val(aid);
    modal.find('#form_download').attr('action', down_action);
})

</script><script>
xn_read_unread({"220405": "1502807505"}, 220405);
</script><script>
jsearch_form = $('#search_form');
jsearch_form.on('submit', function() {
	var keyword = jsearch_form.find('input[name="keyword"]').val();
	var url = xn.url('search-'+xn.urlencode(keyword));
	window.location = url;
	return false;
});
</script><script>
// 语法高亮
if($('div.message pre').length > 0) {
	$.require_css('plugin/xn_syntax_hightlighter/syntax_hightlighter/syntax.css');
	$.require('plugin/xn_syntax_hightlighter/syntax_hightlighter/syntax.js', function() {
		SyntaxHighlighter.all();
	});
}
</script></div></div></body></html>